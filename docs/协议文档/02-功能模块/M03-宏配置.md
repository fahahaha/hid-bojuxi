# M03-宏配置

> 命令码: 0xA3
> 状态: 可用
> 优先级: P1 (扩展功能)

---

## 1. 功能描述

### 1.1 模块职责
配置宏数据到设备存储区，支持最多10个宏，每个宏最多340个按键动作。宏数据支持多帧传输，用于实现复杂的按键序列自动化。

### 1.2 使用场景
- 用户创建新宏
- 用户编辑已有宏
- 用户删除宏（发送空宏）
- 按键绑定宏功能时

### 1.3 前置条件
- 设备已连接并识别
- 宏数据已在驱动端编辑完成
- 若要绑定到按键，需要在M01中设置按键类型为0x07

---

## 2. 协议指令格式说明

### 2.1 请求格式 (PC → 设备)

| Byte | 字段 | 值/范围 | 说明 |
|------|------|---------|------|
| 0 | 包头 | 0xBA | 固定值 |
| 1 | 连接模式 | 0x8A/0xFF | 无线/有线 |
| 2 | 命令码 | 0xA3 | 配置宏 |
| 3 | 数据长度 | LEN | 有效数据长度 |
| 4 | macro_id | 0~9 | 宏ID |
| 5 | total_frames | 1~N | 总帧数 |
| 6 | current_frame | 1~N | 当前帧序号（从1开始） |
| 7 | frame_data_len | 0~56 | 本帧数据长度 |
| 8~63 | macro_data | - | 宏数据内容 |

### 2.2 宏数据格式

**首帧数据区 (Byte 8~63):**

| 字节 | 字段 | 类型 | 说明 |
|------|------|------|------|
| 8~9 | macro_length | uint16 | 宏总长度（低字节在前） |
| 10~11 | loop_count | uint16 | 循环次数（低字节在前） |
| 12~63 | actions | - | 宏动作数据 |

**续帧/结束帧数据区:**
- 直接填充宏动作数据，无需重复宏长度和循环次数

### 2.3 宏动作格式

**普通动作（3字节）:**

| 字节 | 字段 | 说明 |
|------|------|------|
| 1~2 | action_state | 动作状态（bit0:按下/释放, bit1~15:延时ms） |
| 3 | action_code | 动作码（键盘0x04~0xE7, 鼠标0xF0~0xF8） |

**鼠标XY动作（6字节，动作码0xF9）:**

| 字节 | 字段 | 说明 |
|------|------|------|
| 1~2 | action_state | 动作状态（bit1~15:延时ms） |
| 3 | action_code | 0xF9 |
| 4 | xy_high | 高4位=X高4位, 低4位=Y高4位 |
| 5 | x_low | X轴低8位 |
| 6 | y_low | Y轴低8位 |

### 2.4 响应格式 (设备 → PC)

**正常响应 (ACK):**

| Byte | 字段 | 值/范围 | 说明 |
|------|------|---------|------|
| 0 | 包头 | 0x5A | 正常响应 |
| 1 | 连接模式 | 0x8A/0xFF | 无线/有线 |
| 2 | 命令码 | 0xA3 | 配置宏 |
| 3 | 数据长度 | LEN | 与请求相同 |
| 4~63 | 数据区 | - | **原样返回请求数据** |

---

## 3. 请求示例

### 3.1 示例: 配置宏ID0，循环1次，按下A键延时256ms后释放

**请求数据 (Hex):**
```
BA FF A3 20 00 01 01 1C
1C 00 01 00
01 02 04
14 07 04
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
00 00 00 00
```

**字段解析:**
- `BA FF A3`: 包头、有线模式、配置宏命令
- `20`: 数据长度32字节
- `00`: 宏ID 0
- `01`: 总帧数 1
- `01`: 当前帧序号 1
- `1C`: 本帧数据长度 28字节
- `1C 00`: 宏长度 0x001C = 28字节
- `01 00`: 循环次数 1次
- `01 02`: 动作状态 0x0201 (bit0=1按下, 延时256ms)
- `04`: 动作码 A键
- `14 07`: 动作状态 0x0714 (bit0=0释放, 延时906ms)
- `04`: 动作码 A键

### 3.2 示例: 删除宏（空宏）

**请求数据 (Hex):**
```
BA FF A3 08 05 01 01 04
04 00 00 00
00 00 00 00 ... (补0)
```

**字段解析:**
- `05`: 宏ID 5
- `04 00`: 宏长度 = 4
- `00 00`: 循环次数 = 0
- **空宏检测条件**: 宏长度=4 且 循环次数=0

---

## 4. 字段解析

### 4.1 循环次数 (loop_count)

| 值 | 行为 |
|----|------|
| 0x0000~0xFFFD | 执行指定次数后停止 |
| 0xFFFE | 切换模式：第一次按下开始循环，第二次按下停止 |
| 0xFFFF | 按住循环：按下时循环播放，松开停止 |

### 4.2 动作状态 (action_state)

```
bit0:     按下/释放标志 (1=按下, 0=释放)
bit1~15:  延时时间 (单位ms, 最大32768ms)

计算方式:
- 延时时间 = (action_state >> 1)
- 按下标志 = (action_state & 0x01)
```

### 4.3 动作码 (action_code)

| 范围 | 类型 | 说明 |
|------|------|------|
| 0x00 | No Event | macro end |
| 0x01~0x03 | 仅延时 | delay only |
| 0x04~0xE7 | 键盘键码 | HID Usage ID |
| 0xF0 | 鼠标左键 | Mouse L Button |
| 0xF1 | 鼠标右键 | Mouse R Button |
| 0xF2 | 鼠标中键 | Mouse M Button |
| 0xF3 | 鼠标前进键 | Mouse B4 Button |
| 0xF4 | 鼠标后退键 | Mouse B5 Button |
| 0xF5 | 鼠标左倾斜 | Mouse LTilt |
| 0xF6 | 鼠标右倾斜 | Mouse RTilt |
| 0xF7 | 滚轮上滚 | Mouse Scroll up |
| 0xF8 | 滚轮下滚 | Mouse Scroll down |
| 0xF9 | 鼠标XY移动 | Mouse XY (特殊6字节格式) |

### 4.4 鼠标XY坐标计算

```javascript
// 编码
const x = 300;  // 范围: -2048 ~ 2047
const y = -50;
const x_h4 = (x >> 8) & 0x0F;
const y_h4 = (y >> 8) & 0x0F;
const xy_high = (x_h4 << 4) | y_h4;
const x_low = x & 0xFF;
const y_low = y & 0xFF;

// 解码
const x = ((xy_high >> 4) << 8) | x_low;
const y = ((xy_high & 0x0F) << 8) | y_low;
// 处理负数（12位有符号）
if (x > 2047) x -= 4096;
if (y > 2047) y -= 4096;
```

---

## 5. 约束与注意事项

### 5.1 参数约束
- 宏ID范围: 0~9（最多10个宏）
- 每个宏存储区: 1KB
- 最大动作数: 340个（170个按键的按下+释放）
- 宏长度最小值: 4（宏长度2B + 循环次数2B）
- 延时最大值: 32768ms

### 5.2 多帧传输
- 每帧最多56字节宏数据（Byte 8~63）
- 首帧包含宏长度和循环次数（4字节）
- 续帧直接填充动作数据
- 每帧发送后需等待ACK再发下一帧

### 5.3 特殊处理
- **空宏检测**: 宏长度=4 且 循环次数=0，视为删除宏
- **宏冲突**: 同一时刻只能执行一个宏，新宏会终止旧宏
- **鼠标XY**: 仅支持驱动手动添加，不支持录制自动生成

---

## 6. 调试建议

### 6.1 调试步骤
1. 先测试简单的单动作宏
2. 验证延时计算是否正确
3. 测试多帧传输
4. 测试循环模式

### 6.2 日志输出建议
```javascript
console.log('[M03] 宏ID:', macroId);
console.log('[M03] 帧信息:', currentFrame, '/', totalFrames);
console.log('[M03] 宏长度:', macroLength);
console.log('[M03] 循环次数:', loopCount);
console.log('[M03] 动作列表:', actions);
```

---

## 7. 常见错误

| 错误现象 | 可能原因 | 解决方案 |
|----------|----------|----------|
| 返回0x02错误码 | 宏ID超出范围 | 使用0~9 |
| 宏不执行 | 未绑定到按键 | 在M01中设置按键类型为0x07 |
| 延时不准确 | 动作状态计算错误 | 检查bit位移计算 |
| 多帧传输失败 | 帧序号错误 | 确保从1开始递增 |

---

## 8. 相关模块

- [M01-基础设置配置](../01-核心模块/M01-基础设置配置.md) - 按键绑定宏
- [D02-宏数据格式](../04-数据定义/D02-宏数据格式.md) - 宏数据详解
- [A01-键码表](../05-附录/A01-键码表.md) - 动作码参考

---

## 9. 变更记录

| 版本 | 日期 | 修改内容 |
|------|------|----------|
| 1.0 | 2026-01-05 | 初版，基于协议V1.0.5 |
