# M02-基础设置读取

> 命令码: 0xA2
> 状态: 可用
> 优先级: P0 (核心功能)

---

## 1. 功能描述

### 1.1 模块职责

从设备读取当前存储的基础设置配置，用于驱动程序初始化时同步设备状态，或验证配置是否正确写入。

### 1.2 使用场景

- 驱动程序启动时同步设备配置
- 配置写入后验证是否生效
- 切换配置表时读取对应配置
- 设备重连后恢复界面状态

### 1.3 前置条件

- 设备已连接并识别
- 知道要读取的模式和配置表编号

---

## 2. 协议指令格式说明

### 2.1 请求格式 (PC → 设备)

| Byte | 字段            | 值/范围   | 说明                                                                 |
| ---- | --------------- | --------- | -------------------------------------------------------------------- |
| 0    | 包头            | 0xBA      | 固定值                                                               |
| 1    | 连接模式        | 0x8A/0xFF | 无线/有线                                                            |
| 2    | 命令码          | 0xA2      | 读取基础设置                                                         |
| 3    | 数据长度        | 0x04      | 固定4字节                                                            |
| 4    | mode            | 0x01      | 模式（默认0x01）                                                     |
| 5    | table_sub_id    | 0x00/0x01 | 基础设置**子表**编号，指定需要的子表信息                             |
| 6    | profile_id      | 0x00~0xFF | **板载配置**编号，0xFF=返回当前运行的板载配置（首次连接推荐使用）    |
| 7    | reserved        | 0x00      | 保留                                                                 |
| 8~63 | padding         | 0x00      | 与命令相关的数据内容,整包长度不足64的补0                             |

### 2.2 响应格式 (设备 → PC)

**正常响应 (ACK):**

| Byte | 字段     | 值/范围   | 说明                      |
| ---- | -------- | --------- | ------------------------- |
| 0    | 包头     | 0x5A      | 正常响应                  |
| 1    | 连接模式 | 0x8A/0xFF | 无线/有线                 |
| 2    | 命令码   | 0xA2      | 读取基础设置              |
| 3    | 数据长度 | 0x3C      | 60字节                    |
| 4~63 | 数据区   | -         | 基础设置数据（格式同M01） |

**响应数据区格式与M01配置基础设置的数据区完全相同。**

**异常响应 (NACK):**

| Byte | 字段     | 值/范围   | 说明         |
| ---- | -------- | --------- | ------------ |
| 0    | 包头     | 0x5B      | 异常响应     |
| 1    | 连接模式 | 0x8A/0xFF | 无线/有线    |
| 2    | 命令码   | 0xA2      | 读取基础设置 |
| 3    | 数据长度 | 1         | 固定为1      |
| 4    | 错误码   | 0x01~0x08 | 见错误码定义 |

---

## 3. 请求示例

### 3.1 示例1: 读取USB模式默认配置表

**请求数据 (Hex):**

```
BA FF A2 04 01 00 00 00 00 00 00 00 ... (补0至64字节)
```

**字段解析:**

- `BA`: 包头
- `FF`: 有线USB模式
- `A2`: 读取基础设置命令
- `04`: 数据长度4字节
- `01`: USB模式
- `00`: 基础设置表编号0
- `00`: 配置表��号0
- `00`: 保留

### 3.2 示例2: 读取第二套配置

**请求数据 (Hex):**

```
BA FF A2 04 01 00 01 00 00 00 00 00 ... (补0至64字节)
```

**字段解析:**

- `01`: 配置表编号1（第二套配置）

---

## 4. 响应示例

### 4.1 正常响应示例

**响应数据 (Hex):**

```
5A FF A2 3C 01 00 00 00 08 00 02 00
20 03 40 06 80 0C 00 00 00 00 00 00 00 00
06 02
02 00 01 00
02 00 04 00
02 00 02 00
02 00 10 00
02 00 08 00
08 00 00 00
08 00 01 00
05 00 02 00
00 00 00 00
```

**字段解析:**

- `5A`: 正常响应包头
- `FF`: 有线USB模式
- `A2`: 读取基础设置命令
- `3C`: 数据长度60字节
- `01`: 返回的模式（USB）
- `08`: 回报率1000Hz
- `20 03`: DPI档位0 = 800
- `40 06`: DPI档位1 = 1600
- `80 0C`: DPI档位2 = 3200
- `06`: 总共7档
- `02`: 当前档位2

**重要提示:**

- 若Byte4（模式）不是0x01，表示USB和2.4G配置表是分开的
- 驱动应根据此字节判断是否支持共享配置功能

### 4.2 异常响应示例

**响应数据 (Hex):**

```
5B FF A2 01 08
```

**字段解析:**

- `5B`: 异常响应包头
- `08`: 错误码 - 表ID不支持（Table ID Out of Range）

---

## 5. 字段解析

### 5.1 模式字节 (mode)

| 返回值 | 含义     | 驱动处理                 |
| ------ | -------- | ------------------------ |
| 0x01   | 共享模式 | USB和2.4G使用同一配置表  |
| 其他   | 独立模式 | 仅返回当前连接模式的配置 |

### 5.2 板载配置编号 (profile_id)

| 请求值 | 含义                                     |
| ------ | ---------------------------------------- |
| 0x00~N | 指定读取某个板载配置                     |
| 0xFF   | 返回当前运行的板载配置（首次连接推荐）   |

**使用建议**: 首次连接设备时，使用0xFF获取当前运行的板载配置编号，后续操作使用该编号。

### 5.3 响应数据结构

响应数据区（Byte 4~63）的格式与M01配置基础设置完全相同，详见 [M01-基础设置配置](M01-基础设置配置.md)。

---

## 6. 约束与注意事项

### 6.1 参数约束

- 模式字节建议使用0x01
- 配置表编号范围0~1
- 基础设置表编号默认0x00

### 6.2 时序要求

- 建议在驱动启动时首先调用此命令
- 配置写入后建议再次读取验证

### 6.3 特殊处理

- **共享/独立模式判断**: 根据响应Byte4判断
- **多表支持**: 若有多个基础设置表，需分多次获取

---

## 7. 调试建议

### 7.1 调试步骤

1. 发送读取请求
2. 解析响应数据
3. 验证各字段值是否合理
4. 将配置同步到UI界面

### 7.2 日志输出建议

```javascript
console.log('[M02] 发送读取请求')
console.log('[M02] 收到响应:', toHexString(responseData))
console.log('[M02] 解析结果:', {
  mode: data[4],
  pollingRate: data[8],
  dpiLevels: parseDpiLevels(data),
  currentDpi: data[27]
})
```

---

## 8. 常见错误

| 错误现象       | 可能原因           | 解决方案                       |
| -------------- | ------------------ | ------------------------------ |
| 返回0x08错误码 | 配置表编号超出范围 | 使用0或1                       |
| 返回0x04错误码 | Flash读取失败      | 检查设备状态，可能需要恢复出厂 |
| 数据全为0      | 设备未初始化       | 先写入默认配置                 |

---

## 9. 相关模块

- [M01-基础设置配置](M01-基础设置配置.md) - 配置基础设置
- [M05-设备信息获取](../03-系统模块/M05-设备信息获取.md) - 获取设备能力参数
- [M07-恢复出厂设置](../03-系统模块/M07-恢复出厂设置.md) - 重置配置

---

## 10. 变更记录

| 版本 | 日期       | 修改内容                                                     |
| ---- | ---------- | ------------------------------------------------------------ |
| 1.0  | 2026-01-05 | 初版，基于协议V1.0.5                                         |
| 1.1  | 2026-01-16 | 基于V1.0.7更新：板载配置0xFF缺省值、子表编号说明             |
