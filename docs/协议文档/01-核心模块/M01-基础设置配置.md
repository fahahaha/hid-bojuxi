# M01-基础设置配置

> 命令码: 0xA1
> 状态: 可用
> 优先级: P0 (核心功能)

---

## 1. 功能描述

### 1.1 模块职责

配置鼠标的核心参数，包括回报率、DPI档位、按键映射、滚轮设置等。这是驱动程序最核心的配置功能模块。

### 1.2 使用场景

- 用户修改回报率设置
- 用户调整DPI档位和数值
- 用户自定义按键映射
- 用户修改滚轮方向
- 用户绑定宏到按键

### 1.3 前置条件

- 设备已连接并识别
- 建议先调用M05获取设备信息，确认DPI范围等参数
- 建议先调用M02读取当前设置，避免覆盖其他配置

---

## 2. 协议指令格式说明

### 2.1 请求格式 (PC → 设备)

| Byte | 字段                                    | 值/范围   | 说明         |
| ---- | --------------------------------------- | --------- | ------------ |
| 0    | 包头                                    | 0xBA      | 固定值       |
| 1    | 连接模式                                | 0x8A/0xFF | 无线/有线    |
| 2    | 命令码                                  | 0xA1      | 配置基础设置 |
| 3    | 数据长度                                | 0x3C (60) | 固定60字节   |
| 4~63 | 与命令相关的数据内容,整包长度不足64的补 | -         | 基础设置数据 |

**数据区详细定义 (Byte 4~63)：**

| 字节  | 字段名            | 类型    | 范围          | 默认值      | 说明                                                               |
| ----- | ----------------- | ------- | ------------- | ----------- | ------------------------------------------------------------------ |
| 4     | mode              | uint8   | bit0~2        | -           | bit0:USB, bit1:2.4G, bit2:BLE，当前只会用到USB和2.4g               |
| 5     | table_base_id     | uint8   | 0~N           | 0x00        | 基础设置表编号                                                     |
| 6     | table_config_id   | uint8   | 0~1           | 0x00        | 配置表编号（最多2套）                                              |
| 7     | reserved          | uint8   | -             | 0x00        | 保留                                                               |
| 8     | polling_rate      | uint8   | 0x01/02/04/08 | 0x08        | 回报率0x01（125Hz） 0x02（250Hz）<br/>0x04（500Hz） 0x08（1000Hz） |
| 9     | wheel_direction   | uint8   | 0x00/0x01     | 0x00        | 滚轮方向 正向 0x00 ，反向0x01                                      |
| 10    | lod               | uint8   | -             | 0x02        | 静默高度（固定，暂不开放）                                         |
| 11    | reserved          | uint8   | -             | 0x00        | 保留                                                               |
| 12~13 | dpi_level_0       | uint16  | 50~16000      | -           | DPI档位0（低字节在前）                                             |
| 14~15 | dpi_level_1       | uint16  | 50~16000      | -           | DPI档位1                                                           |
| 16~17 | dpi_level_2       | uint16  | 50~16000      | -           | DPI档位2                                                           |
| 18~19 | dpi_level_3       | uint16  | 50~16000      | -           | DPI档位3                                                           |
| 20~21 | dpi_level_4       | uint16  | 50~16000      | -           | DPI档位4                                                           |
| 22~23 | dpi_level_5       | uint16  | 50~16000      | -           | DPI档位5                                                           |
| 24~25 | dpi_level_6       | uint16  | 50~16000      | -           | DPI档位6                                                           |
| 26    | dpi_total_levels  | uint8   | 0~6           | 6           | DPI总档位数（0=1档）                                               |
| 27    | dpi_current_level | uint8   | 0~6           | 2           | 当前DPI档位                                                        |
| 28~31 | btn_left          | 4 bytes | -             | 02 00 01 00 | 左键配置（暂不开放修改）                                           |
| 32~35 | btn_middle        | 4 bytes | -             | 02 00 04 00 | 中键配置                                                           |
| 36~39 | btn_right         | 4 bytes | -             | 02 00 02 00 | 右键配置                                                           |
| 40~43 | btn_forward       | 4 bytes | -             | 02 00 10 00 | 前进键配置                                                         |
| 44~47 | btn_backward      | 4 bytes | -             | 02 00 08 00 | 后退键配置                                                         |
| 48~51 | wheel_up          | 4 bytes | -             | 08 00 00 00 | 滚轮前滚配置*(**暂不开放修改**,**也不显示**)*                      |
| 52~55 | wheel_down        | 4 bytes | -             | 08 00 01 00 | 滚轮后滚配置*(**暂不开放修改**,**也不显示**)*                      |
| 56~59 | btn_dpi           | 4 bytes | -             | 05 00 02 00 | DPI键配置                                                          |
| 60~63 | reserved          | 4 bytes | -             | 0x00        | 保留                                                               |

### 2.2 响应格式 (设备 → PC)

**正常响应 (ACK):**

| Byte | 字段     | 值/范围   | 说明                 |
| ---- | -------- | --------- | -------------------- |
| 0    | 包头     | 0x5A      | 正常响应             |
| 1    | 连接模式 | 0x8A/0xFF | 无线/有线            |
| 2    | 命令码   | 0xA1      | 配置基础设置         |
| 3    | 数据长度 | 0x3C      | 60字节               |
| 4~63 | 数据区   | -         | **原样返回请求数据** |

**异常响应 (NACK):**

| Byte | 字段     | 值/范围   | 说明         |
| ---- | -------- | --------- | ------------ |
| 0    | 包头     | 0x5B      | 异常响应     |
| 1    | 连接模式 | 0x8A/0xFF | 无线/有线    |
| 2    | 命令码   | 0xA1      | 配置基础设置 |
| 3    | 数据长度 | 1         | 固定为1      |
| 4    | 错误码   | 0x01~0x08 | 见错误码定义 |

---

## 3. 请求示例

### 3.1 示例1: 设置1000Hz回报率 + DPI 800/1600/3200

**请求数据 (Hex):**

```
BA FF A1 3C 01 00 00 00 08 00 02 00
20 03 40 06 80 0C 00 00 00 00 00 00 00 00
02 02
02 00 01 00
02 00 04 00
02 00 02 00
02 00 10 00
02 00 08 00
08 00 00 00
08 00 01 00
05 00 02 00
00 00 00 00
```

**字段解析:**

- `BA`: 包头
- `FF`: 有线USB模式
- `A1`: 配置基础设置命令
- `3C`: 数据长度60字节
- `01`: USB模式
- `00 00 00`: 表编号和保留
- `08`: 回报率1000Hz
- `00`: 滚轮正向
- `02 00`: 静默高度和保留
- `20 03`: DPI档位0 = 0x0320 = 800
- `40 06`: DPI档位1 = 0x0640 = 1600
- `80 0C`: DPI档位2 = 0x0C80 = 3200
- `02`: 总共3档（0=1档，2=3档）
- `02`: 当前选择档位2（第3档）

### 3.2 示例2: 将后退键映射为Ctrl+C

**按键配置部分 (Byte 44~47):**

```
01 02 06 00
```

**字段解析:**

- `01`: 键盘组合键类型
- `02`: Modify key = L-Ctrl (bit1=1)
- `06`: Key code = C键
- `00`: 无第二个键码

---

## 4. 响应示例

### 4.1 正常响应示例

**响应数据 (Hex):**

```
5A FF A1 3C 01 00 00 00 08 00 02 00 ...（与请求数据相同）
```

**校验方式:**
驱动端应比对响应数据与请求数据是否完全一致，不一致则触发重传机制。

### 4.2 异常响应示例

**响应数据 (Hex):**

```
5B FF A1 01 02
```

**字段解析:**

- `5B`: 异常响应包头
- `FF`: 有线USB模式
- `A1`: 配置基础设置命令
- `01`: 错误数据长度
- `02`: 错误码 - 参数异常（Invalid Parameter）

---

## 5. 字段解析

### 5.1 回报率 (polling_rate)

| 值   | 含义   | 说明                |
| ---- | ------ | ------------------- |
| 0x01 | 125Hz  | 8ms响应间隔         |
| 0x02 | 250Hz  | 4ms响应间隔         |
| 0x04 | 500Hz  | 2ms响应间隔         |
| 0x08 | 1000Hz | 1ms响应间隔（默认） |

### 5.2 滚轮方向 (wheel_direction)

| 值   | 含义         |
| ---- | ------------ |
| 0x00 | 正向（默认） |
| 0x01 | 反向         |

### 5.3 DPI值

- **范围**: 50 ~ 16000
- **分度值**: 50（默认）
- **存储格式**: uint16，低字节在前
- **计算示例**: DPI=800 → 0x0320 → 存储为 `20 03`

### 5.4 按键配置4字节格式

详见 [D01-按键配置格式](../04-数据定义/D01-按键配置格式.md)

| Byte1 | 类型       | Byte2      | Byte3       | Byte4    |
| ----- | ---------- | ---------- | ----------- | -------- |
| 0x00  | 键盘单键   | 0x00       | Key code    | 0x00     |
| 0x01  | 键盘组合键 | Modify key | Key code    | 2nd code |
| 0x02  | 鼠标按键   | 0x00       | Button ID   | 0x00     |
| 0x03  | 多媒体键   | 0x00       | 键值高位    | 键值低位 |
| 0x04  | 禁用按键   | 0x00       | 0x00        | 0x00     |
| 0x05  | DPI按键    | 0x00       | DPI change  | 0x00     |
| 0x06  | 功能按键   | 0x00       | Function ID | 0x00     |
| 0x07  | 宏定义     | 0x00       | Macro ID    | 0x00     |
| 0x08  | 滚轮       | 0x00       | 方向        | 连续滚动 |

---

## 6. 约束与注意事项

### 6.1 参数约束

- DPI值必须在设备支持范围内（默认50~16000）
- DPI值应为分度值的整数倍（默认分度值50）
- 当前DPI档位不能超过总档位数
- 左键配置暂不开放修改
- 静默高度暂不开放修改

### 6.2 时序要求

- 发送配置后需等待ACK响应
- ACK异常时最多重传3次，间隔100ms
- 建议配置完成后调用M02读取验证

### 6.3 特殊处理

- **共享/独立模式**: 由项目固定，不开放用户修改
- **配置表编号**: 同一模式最多支持2套配置（0和1）
- **按键绑定宏**: 需要先通过M03配置宏数据

---

## 7. 调试建议

### 7.1 调试步骤

1. 先调用M05获取设备信息，确认DPI范围
2. 调用M02读取当前配置作为基准
3. 修改需要变更的字段
4. 发送M01配置命令
5. 比对ACK响应数据
6. 再次调用M02验证配置是否生效

### 7.2 日志输出建议

```javascript
console.log('[M01] 发送配置请求:', toHexString(requestData))
console.log('[M01] 收到响应:', toHexString(responseData))
console.log('[M01] 数据校验:', isDataMatch ? '通过' : '失败')
```

### 7.3 常用调试场景

- 单独修改回报率：只改Byte8
- 单独修改DPI：改Byte12~27
- 单独修改按键映射：改对应按键的4字节

---

## 8. 常见错误

| 错误现象       | 可能原因                        | 解决方案                      |
| -------------- | ------------------------------- | ----------------------------- |
| 返回0x02错误码 | DPI值超出范围或不是分度值整数倍 | 检查DPI值是否在50~16000范围内 |
| 返回0x01错误码 | 数据长度不是60字节              | 确保LEN=0x3C，数据区60字节    |
| ACK数据不匹配  | 设备未正确处理                  | 触发重传机制                  |
| 配置不生效     | 模式字节不匹配                  | 检查Byte4的模式位是否正确     |
| 按键映射无效   | 按键类型码错误                  | 检查Byte1的类型值是否正确     |

---

## 9. 相关模块

- [M02-基础设置读取](M02-基础设置读取.md) - 读取当前配置
- [M03-宏配置](../02-功能模块/M03-宏配置.md) - 按键绑定宏时需要
- [M05-设备信息获取](../03-系统模块/M05-设备信息获取.md) - 获取DPI范围等参数
- [D01-按键配置格式](../04-数据定义/D01-按键配置格式.md) - 按键配置详解

---

## 10. 变更记录

| 版本 | 日期       | 修改内容             |
| ---- | ---------- | -------------------- |
| 1.0  | 2026-01-05 | 初版，基于协议V1.0.5 |
