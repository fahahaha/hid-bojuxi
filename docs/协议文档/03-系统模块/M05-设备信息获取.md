# M05-设备信息获取

> 命令码: 0xA5
> 状态: 可用（调试用）
> 优先级: P0 (初始化必需)

---

## 1. 功能描述

### 1.1 模块职责

获取设备的硬件信息和固件版本，包括设备编号、版本号、传感器型号、DPI范围等参数。这些信息用于驱动程序初始化时确定设备能力。

### 1.2 使用场景

- 驱动程序启动时获取设备能力
- 显示设备信息页面
- 根据设备能力动态调整UI参数范围
- 调试时确认设备状态

### 1.3 前置条件

- 设备已连接并识别

---

## 2. 协议指令格式说明

### 2.1 请求格式 (PC → 设备)

| Byte | 字段     | 值/范围   | 说明             |
| ---- | -------- | --------- | ---------------- |
| 0    | 包头     | 0xBA      | 固定值           |
| 1    | 连接模式 | 0x8A/0xFF | 无线/有线        |
| 2    | 命令码   | 0xA5      | 获取设备信息     |
| 3    | 数据长度 | 0x02      | 固定2字节        |
| 4    | mode     | 0x01      | 模式（默认0x01） |
| 5    | table_id | 0x00      | 设备信息表编号   |
| 6~63 | padding  | 0x00      | 补0              |

### 2.2 响应格式 (设备 → PC)

**正常响应 (ACK):**

| Byte | 字段     | 值/范围   | 说明         |
| ---- | -------- | --------- | ------------ |
| 0    | 包头     | 0x5A      | 正常响应     |
| 1    | 连接模式 | 0x8A/0xFF | 无线/有线    |
| 2    | 命令码   | 0xA5      | 获取设备信息 |
| 3    | 数据长度 | 0x3C      | 60字节       |
| 4~63 | 数据区   | -         | 设备信息数据 |

**响应数据区详细定义 (Byte 4~63):**

| 字节  | 字段名    | 类型    | 默认值 | 说明                    |
| ----- | --------- | ------- | ------ | ----------------------- |
| 4     | mode      | uint8   | 0x01   | 模式                    |
| 5     | table_id  | uint8   | 0x00   | 设备信息表编号          |
| 6~7   | reserved  | -       | 0x00   | 保留                    |
| 8~9   | device_id | uint16  | 0x0000 | 设备编号（低字节在前）  |
| 10~11 | version   | uint16  | -      | 版本号（如0x0101=V1.1） |
| 12~14 | sensor_id | 3 bytes | -      | 传感器编号              |
| 15~16 | dpi_step  | uint16  | 0x0032 | DPI分度值（50）         |
| 17~18 | dpi_min   | uint16  | 0x0032 | DPI最小值（50）         |
| 19~20 | dpi_max   | uint16  | 0x3E80 | DPI最大值（16000）      |
| 21    | lod_step  | uint8   | 0x10   | 静默高度分度值          |
| 22    | lod_min   | uint8   | 0x10   | 静默高度最小值          |
| 23    | lod_max   | uint8   | 0x20   | 静默高度最大值          |
| 24~63 | reserved  | -       | 0x00   | 保留                    |

---

## 3. 请求示例

### 3.1 示例: 获取默认设备信息

**请求数据 (Hex):**

```
BA FF A5 02 01 00 00 00 00 00 ... (补0至64字节)
```

**字段解析:**

- `BA`: 包头
- `FF`: 有线USB模式
- `A5`: 获取设备信息命令
- `02`: 数据长度2字节
- `01`: 模式
- `00`: 设备信息表编号0

---

## 4. 响应示例

### 4.1 正常响应示例

**响应数据 (Hex):**

```
5A FF A5 3C 01 00 00 00
00 00 01 01 00 00 00
32 00 32 00 80 3E
10 10 20
00 00 00 00 ... (补0)
```

**字段解析:**

- `5A`: 正常响应包头
- `01 00`: 模式和表编号
- `00 00`: 设备编号 0x0000
- `01 01`: 版本号 0x0101 = V1.1
- `32 00`: DPI分度值 0x0032 = 50
- `32 00`: DPI最小值 0x0032 = 50
- `80 3E`: DPI最大值 0x3E80 = 16000
- `10`: 静默高度分度值 1.0mm
- `10`: 静默高度最小值 1.0mm
- `20`: 静默高度最大值 2.0mm

---

## 5. 字段解析

### 5.1 版本号 (version)

```javascript
// 解析版本号
const version = (data[11] << 8) | data[10]
const major = (version >> 8) & 0xff
const minor = version & 0xff
console.log(`V${major}.${minor}`) // 如 V1.1
```

### 5.2 DPI分度值 (dpi_step)

| 值     | 含义                      |
| ------ | ------------------------- |
| 0x0000 | 不支持分度值，每档固定DPI |
| 0x0032 | 分度值50（默认）          |
| 其他   | 自定义分度值              |

### 5.3 静默高度 (LOD) 编码

```
高4位: 个位数
低4位: 小数点后一位

示例:
0x10 = 1.0mm
0x01 = 0.1mm
0x11 = 1.1mm
0x20 = 2.0mm
```

---

## 6. 约束与注意事项

### 6.1 使用建议

- 驱动启动时首先调用此命令
- 根据返回的DPI范围限制UI输入
- 根据DPI分度值设置滑块步进

### 6.2 特殊处理

- 若DPI分度值为0，表示不支持自定义DPI
- 静默高度功能当前暂不开放修改

---

## 7. 调试建议

### 7.1 日志输出建议

```javascript
console.log('[M05] 设备信息:', {
  deviceId: deviceId,
  version: `V${major}.${minor}`,
  dpiRange: `${dpiMin} ~ ${dpiMax}`,
  dpiStep: dpiStep,
  lodRange: `${lodMin}mm ~ ${lodMax}mm`
})
```

---

## 8. 常见错误

| 错误现象       | 可能原因         | 解决方案         |
| -------------- | ---------------- | ---------------- |
| 返回0x08错误码 | 表编号超出范围   | 使用默认值0x00   |
| DPI范围异常    | 设备未正确初始化 | 尝试恢复出厂设置 |

---

## 9. 相关模块

- [M01-基础设置配置](../01-核心模块/M01-基础设置配置.md) - 使用DPI范围参数
- [M02-基础设置读取](../01-核心模块/M02-基础设置读取.md) - 读取当前配置

---

## 10. 变更记录

| 版本 | 日期       | 修改内容             |
| ---- | ---------- | -------------------- |
| 1.0  | 2026-01-05 | 初版，基于协议V1.0.5 |
