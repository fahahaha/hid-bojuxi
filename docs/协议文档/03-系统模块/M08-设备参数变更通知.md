# M08-设备参数变更通知

> 命令码: 0xB2
> 状态: 可用
> 优先级: P1 (事件监听)
> 方向: 设备 → PC（主动通知）

---

## 1. 功能描述

### 1.1 模块职责

由设备端自动发起的参数变更通知，通知PC端当前设备状态（电池、DPI、板载配置等），PC端比对与当前设置是否一致，用于同步信息。

### 1.2 使用场景

- 设备电池状态变化时自动上报
- 用户在设备上切换DPI档位时同步到PC
- 用户在设备上切换板载配置时同步到PC
- 设备端参数变更后，PC端UI实时响应

### 1.3 前置条件

- 设备已连接
- PC端已开启HID InputReport监听

---

## 2. 协议指令格式说明

### 2.1 设备参数变更通知 (设备 → PC)

| Byte | 字段       | 值/范围   | 说明                     |
| ---- | ---------- | --------- | ------------------------ |
| 0    | 包头       | 0x5A      | 设备到PC包头             |
| 1    | 连接模式   | 0x8A/0xFF | 无线/有线                |
| 2    | 命令码     | 0xB2      | 设备参数变更通知         |
| 3    | 数据长度   | 0x0B      | 固定11字节               |
| 4~63 | 数据       | -         | 参数数据                 |

### 2.2 数据字段详细说明

| Byte | 字段                | 说明                                                   |
| ---- | ------------------- | ------------------------------------------------------ |
| 4    | 电池状态            | 0x00:空闲，0x01:充电中，0x02:充满电，0x03:未稳定       |
| 5    | 电压值低字节        | Uint16低字节                                           |
| 6    | 电压值高字节        | Uint16高字节，如3205表示3.205V                         |
| 7    | 电池百分比          | 0~100%，如0x20表示32%，最大值0x64表示100%              |
| 8    | 保留                | 0x00                                                   |
| 9    | DPI当前档位         | 当前DPI档位(0~6)                                       |
| 10   | DPI XY轴分离掩码    | XY轴的DPI分离设置掩码                                  |
| 11   | DPI值低字节(X轴)    | 当前档位DPI值低字节                                    |
| 12   | DPI值高字节(X轴)    | 当前档位DPI值高字节                                    |
| 13   | Y轴DPI值低字节      | Y轴当前档位DPI值低字节                                 |
| 14   | Y轴DPI值高字节      | Y轴当前档位DPI值高字节                                 |
| 15   | 保留                | 0x00                                                   |
| 16   | 当前板载配置编号    | 当前选择的板载配置                                     |
| 17~63| 保留                | 0x00                                                   |

---

## 3. ACK响应

### 3.1 设备参数变更ACK (PC → 设备)

| Byte | 字段       | 值/范围   | 说明                     |
| ---- | ---------- | --------- | ------------------------ |
| 0    | 包头       | 0xBA      | PC到设备包头             |
| 1    | 连接模式   | 0x8A/0xFF | 无线/有线                |
| 2    | 命令码     | 0xB2      | 设备参数变更ACK          |
| 3    | 数据长度   | 0x0B      | 固定11字节               |
| 4~63 | 数据       | -         | 原样返回接收到的数据     |

**描述**: 将收到的数据原样返回

---

## 4. 实现建议

### 4.1 监听实现

```javascript
// 在设备连接后开启监听
device.addEventListener('inputreport', (event) => {
  const data = new Uint8Array(event.data.buffer)

  // 检查是否为参数变更通知
  if (data[0] === 0x5A && data[2] === 0xB2) {
    handleParameterChange(data)
  }
})

function handleParameterChange(data) {
  // 电池信息
  const batteryStatus = data[4]
  const voltage = data[5] | (data[6] << 8)
  const batteryPercent = data[7]

  // DPI信息
  const dpiLevel = data[9]
  const dpiSeparateMask = data[10]
  const dpiValueX = data[11] | (data[12] << 8)
  const dpiValueY = data[13] | (data[14] << 8)

  // 板载配置
  const profileId = data[16]

  // 更新UI显示
  updateBatteryDisplay(batteryStatus, voltage, batteryPercent)
  updateDpiDisplay(dpiLevel, dpiValueX, dpiValueY, dpiSeparateMask)
  updateProfileDisplay(profileId)

  // 发送ACK
  sendAck(data)
}
```

### 4.2 注意事项

- 监听应在设备连接成功后立即开启
- 监听应在设备断开时移除
- 处理通知时应避免阻塞UI线程
- 收到通知后需要发送ACK确认
- 电池状态为0x03(未稳定)时应抛弃数据

---

## 5. 相关模块

- [M01-基础设置配置](../01-核心模块/M01-基础设置配置.md) - 配置基础设置
- [M02-基础设置读取](../01-核心模块/M02-基础设置读取.md) - 读取配置
- [M06-电池信息读取](M06-电池信息读取.md) - 电池信息

---

## 6. 变更记录

| 版本 | 日期       | 修改内容                     |
| ---- | ---------- | ---------------------------- |
| 1.0  | 2026-01-17 | 修正版本，基于协议V1.0.7     |
