# A02-错误码定义

> Error Code Definitions
> 适用于所有NACK响应 (包头0x5B)

---

## 1. 错误码列表

| 错误码 (Hex) | 含义 | 触发场景 |
|--------------|------|----------|
| 0x00 | 保留 | 不应出现，若收到视为未知状态 |
| 0x01 | 长度异常 (Length Mismatch) | 包头中LEN字段与实际有效payload长度不符 |
| 0x02 | 参数异常 (Invalid Parameter) | 模式、表ID、DPI值、宏ID等错误或超出合法范围 |
| 0x03 | 命令不支持 (Command Not Supported) | 收到未定义的sub_cmd（如0xA8、0xFF等） |
| 0x04 | Flash读取失败 (Flash Read Error) | 从非易失存储器读取配置/宏数据时发生硬件或驱动错误 |
| 0x05 | Flash擦除失败 (Flash Erase Error) | 擦除Flash扇区失败（可能因写保护、电压不稳等） |
| 0x06 | Flash写入失败 (Flash Write Error) | 向Flash写入配置/宏数据失败 |
| 0x07 | 数据校验失败 (Checksum/CRC Error) | 读取的配置块CRC16校验不通过，数据可能已损坏 |
| 0x08 | 表ID不支持 (Table ID Out of Range) | 请求的子表ID超出设备支持范围 |
| 0x09~0xFF | 保留 | 未来扩展使用，请勿依赖 |

---

## 2. 错误处理建议

### 2.1 0x01 长度异常

**原因分析:**
- 数据包LEN字段计算错误
- 数据区填充不完整

**处理方案:**
1. 检查LEN字段是否正确
2. 确保数据区长度与LEN一致
3. 重新构建数据包后重试

### 2.2 0x02 参数异常

**原因分析:**
- DPI值超出范围（50~16000）
- DPI值不是分度值的整数倍
- 宏ID超出范围（0~9）
- 配置表编号超出范围（0~1）

**处理方案:**
1. 先调用M05获取设备参数范围
2. 校验参数后再发送
3. 提示用户修正输入

### 2.3 0x03 命令不支持

**原因分析:**
- 使用了暂不开发的命令（如0xA4、0xA8）
- 命令码错误

**处理方案:**
1. 检查命令码是否正确
2. 确认设备固件版本是否支持

### 2.4 0x04~0x06 Flash操作失败

**原因分析:**
- 设备存储器硬件故障
- 电压不稳定
- 写保护

**处理方案:**
1. 重试操作
2. 尝试恢复出厂设置
3. 若持续失败，可能需要返修

### 2.5 0x07 数据校验失败

**原因分析:**
- 存储的数据已损坏
- CRC校验不通过

**处理方案:**
1. 尝试恢复出厂设置
2. 重新写入配置

### 2.6 0x08 表ID不支持

**原因分析:**
- 请求的表编号超出设备支持范围

**处理方案:**
1. 使用默认表编号（0x00）
2. 检查设备支持的表数量

---

## 3. 代码示例

```javascript
const ERROR_CODES = {
  0x00: { name: 'Reserved', message: '保留错误码' },
  0x01: { name: 'Length Mismatch', message: '数据长度异常' },
  0x02: { name: 'Invalid Parameter', message: '参数异常' },
  0x03: { name: 'Command Not Supported', message: '命令不支持' },
  0x04: { name: 'Flash Read Error', message: 'Flash读取失败' },
  0x05: { name: 'Flash Erase Error', message: 'Flash擦除失败' },
  0x06: { name: 'Flash Write Error', message: 'Flash写入失败' },
  0x07: { name: 'Checksum Error', message: '数据校验失败' },
  0x08: { name: 'Table ID Out of Range', message: '表ID不支持' }
};

function handleNackResponse(data) {
  if (data[0] !== 0x5B) return null;

  const errorCode = data[4];
  const errorInfo = ERROR_CODES[errorCode] || {
    name: 'Unknown',
    message: '未知错误'
  };

  console.error(`[NACK] 命令0x${data[2].toString(16)} 失败:`,
    errorInfo.name, '-', errorInfo.message);

  return {
    command: data[2],
    errorCode: errorCode,
    errorName: errorInfo.name,
    errorMessage: errorInfo.message
  };
}
```

---

## 4. 相关文档

- [协议总索引](../协议总索引.md)
