# 项目整体架构说明

## 1. 项目概述

本项目是一个基于 **Electron + Vue 3 + TypeScript** 的通用游戏鼠标驱动程序，通过 WebHID API 与游戏鼠标设备进行通信。当前 Demo 使用 YHH（银火狐/YJX）鼠标协议作为示例实现。

## 2. 技术栈

| 层级     | 技术                         | 说明           |
| -------- | ---------------------------- | -------------- |
| 框架     | Electron                     | 跨平台桌面应用 |
| 前端     | Vue 3 + Composition API      | 响应式 UI      |
| 语言     | TypeScript                   | 类型安全       |
| 样式     | Tailwind CSS + CSS Variables | 主题化样式     |
| 构建     | electron-vite                | 快速构建       |
| 设备通信 | WebHID API                   | HID 设备访问   |

## 3. 目录结构

```
src/
├── main/                          # Electron 主进程
│   └── index.ts                   # 主进程入口，WebHID 权限配置
│
├── preload/                       # 预加载脚本
│   ├── index.ts                   # contextBridge 暴露 API
│   └── index.d.ts                 # 类型声明
│
└── renderer/                      # 渲染进程 (Vue 应用)
    └── src/
        ├── main.ts                # Vue 应用入口
        ├── App.vue                # 主应用组件
        │
        ├── components/            # UI 组件层
        │   ├── BasicSettings.vue      # 基础设置 (回报率/DPI/滚轮)
        │   ├── BacklightSettings.vue  # 背光设置
        │   ├── ButtonMapping.vue      # 按键映射
        │   ├── DeviceInfo.vue         # 设备信息
        │   ├── MacroManagement.vue    # 宏管理
        │   └── Versions.vue           # 版本信息
        │
        ├── composables/           # 业务逻辑层 (Service)
        │   ├── useWebHID.ts           # WebHID 核心服务 ★
        │   ├── useI18n.ts             # 国际化
        │   ├── useTheme.ts            # 主题切换
        │   └── useMacroStorage.ts     # 宏存储管理
        │
        ├── protocols/             # 协议层 (Protocol)
        │   ├── index.ts               # 协议接口定义 ★
        │   ├── registry.ts            # 协议注册中心 ★
        │   ├── yhh.ts                 # YHH 鼠标协议实现 ★
        │   └── generic.ts             # 通用协议 (默认)
        │
        ├── config/                # 配置层
        │   └── buttonMappings.ts      # 按键映射配置
        │
        ├── locales/               # 国际化资源
        │   ├── zh-CN.ts
        │   └── en-US.ts
        │
        ├── types/                 # 类型定义
        │   └── webhid.d.ts            # WebHID API 类型
        │
        ├── utils/                 # 工具函数
        │   └── env.ts
        │
        └── assets/                # 静态资源
            └── mouse.png              # 鼠标示意图
```

## 4. 三层架构

### 4.1 架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                         UI 层 (Components)                       │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐             │
│  │BasicSettings │ │BacklightSet. │ │ButtonMapping │ ...         │
│  └──────┬───────┘ └──────┬───────┘ └──────┬───────┘             │
│         │                │                │                      │
│         └────────────────┼────────────────┘                      │
│                          ▼                                       │
├─────────────────────────────────────────────────────────────────┤
│                    Service 层 (Composables)                      │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                     useWebHID.ts                         │    │
│  │  - connectDevice()      - setReportRate()               │    │
│  │  - autoConnectDevice()  - setDPI()                      │    │
│  │  - getDeviceInfo()      - setButtonMapping()            │    │
│  │  - sendReport()         - setMacro()                    │    │
│  └─────────────────────────┬───────────────────────────────┘    │
│                            │                                     │
│                            ▼                                     │
├─────────────────────────────────────────────────────────────────┤
│                    Protocol 层 (Protocols)                       │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │   index.ts  │  │ registry.ts │  │   yhh.ts    │              │
│  │ (接口定义)   │  │ (协议注册)   │  │ (YHH协议)   │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
│                            │                                     │
│                            ▼                                     │
├─────────────────────────────────────────────────────────────────┤
│                    WebHID API (浏览器原生)                        │
│  navigator.hid.requestDevice() / device.sendReport()            │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 层级职责

| 层级            | 文件位置                   | 职责                                  |
| --------------- | -------------------------- | ------------------------------------- |
| **UI 层**       | `components/*.vue`         | 用户界面展示、用户交互、状态显示      |
| **Service 层**  | `composables/useWebHID.ts` | 设备连接管理、命令发送/接收、状态管理 |
| **Protocol 层** | `protocols/*.ts`           | 协议定义、命令编码、响应解析          |

## 5. WebHID 调用点

### 5.1 主进程权限配置

**文件**: `src/main/index.ts`

```typescript
// 设备权限处理器 - 自动授予 HID 设备权限
mainWindow.webContents.session.setDevicePermissionHandler((details) => {
  if (details.deviceType === 'hid') {
    return true
  }
  return false
})

// HID 设备选择处理 - 自动选择目标设备
mainWindow.webContents.session.on('select-hid-device', (event, details, callback) => {
  // 优先选择 VID: 0xa8a4, PID: 0x2255 的设备
  const targetDevice = details.deviceList.find(
    (device) => device.vendorId === 0xa8a4 && device.productId === 0x2255
  )
  callback(targetDevice?.deviceId || details.deviceList[0]?.deviceId || '')
})
```

### 5.2 渲染进程 WebHID 调用

**文件**: `src/renderer/src/composables/useWebHID.ts`

| 方法                  | WebHID API                               | 说明             |
| --------------------- | ---------------------------------------- | ---------------- |
| `connectDevice()`     | `navigator.hid.requestDevice()`          | 请求用户选择设备 |
| `autoConnectDevice()` | `navigator.hid.getDevices()`             | 获取已授权设备   |
| `sendReport()`        | `device.sendReport(0, data)`             | 发送命令到设备   |
| `waitForResponse()`   | `device.addEventListener('inputreport')` | 监听设备响应     |

### 5.3 数据流向

```
用户操作 → UI组件 → useWebHID → Protocol.commands → device.sendReport()
                                                           ↓
用户界面 ← UI组件 ← useWebHID ← Protocol.parsers ← device.inputreport
```

## 6. 协议封装位置

### 6.1 协议接口定义

**文件**: `src/renderer/src/protocols/index.ts`

```typescript
export interface DeviceProtocol {
  name: string                           // 协议名称
  identify: (device: HIDDevice) => boolean  // 设备识别函数

  commands: {                            // 命令定义
    getDeviceInfo: number[]              // 获取设备信息
    getBattery: number[]                 // 获取电池状态
    getReportRate: number[]              // 获取回报率
    getDPI: number[]                     // 获取 DPI
    getBacklight: number[]               // 获取背光
    getButtonMapping: number[]           // 获取按键映射
    setReportRate: (rate, ...) => number[]
    setDPI: (level, value, ...) => number[]
    // ... 更多命令
  }

  parsers: {                             // 响应解析器
    deviceInfo: (response) => { name, model, firmwareVersion }
    battery: (response) => number
    dpi: (response) => { value, level, reportRate }
    // ... 更多解析器
  }

  features?: {                           // 设备特性配置
    supportedDPI?: number[]
    supportedReportRates?: number[]
    buttonCount?: number
    hasRGB?: boolean
    // ... 更多特性
  }
}
```

### 6.2 协议注册中心

**文件**: `src/renderer/src/protocols/registry.ts`

```typescript
export const protocolRegistry: DeviceProtocol[] = [
  yhhProtocol, // YHH 鼠标协议 (优先匹配)
  genericProtocol // 通用协议 (默认)
]

export function detectProtocol(device: HIDDevice): DeviceProtocol {
  return protocolRegistry.find((p) => p.identify(device)) || genericProtocol
}
```

### 6.3 YHH 协议实现

**文件**: `src/renderer/src/protocols/yhh.ts`

- 发送包头: `0x55`
- 接收包头: `0xAA`
- ReportID: `0`
- 支持功能: DPI(6档)、回报率(4档)、按键映射(8键)、宏(10个)、滚轮方向

## 7. UI / Service / Protocol 边界

### 7.1 边界定义

```
┌─────────────────────────────────────────────────────────────────┐
│ UI 层边界                                                        │
│ - 只负责展示和用户交互                                            │
│ - 不直接操作 WebHID API                                          │
│ - 通过 useWebHID 获取状态和调用方法                               │
│ - 不关心具体协议细节                                              │
├─────────────────────────────────────────────────────────────────┤
│ Service 层边界                                                   │
│ - 管理设备连接状态                                                │
│ - 封装 WebHID API 调用                                           │
│ - 协调 Protocol 层进行命令编码/解码                               │
│ - 提供统一的业务接口给 UI 层                                      │
├─────────────────────────────────────────────────────────────────┤
│ Protocol 层边界                                                  │
│ - 定义协议接口规范                                                │
│ - 实现具体设备的命令编码                                          │
│ - 实现具体设备的响应解析                                          │
│ - 声明设备支持的特性                                              │
└─────────────────────────────────────────────────────────────────┘
```

### 7.2 调用关系示例

```typescript
// UI 层 (BasicSettings.vue)
const { setDPI, deviceStatus } = useWebHID()
await setDPI(level, value)  // 只关心业务语义

// Service 层 (useWebHID.ts)
async function setDPI(level, value) {
  const command = currentProtocol.value.commands.setDPI(level, value, ...)
  await sendReport(command)
  await getCurrentDPI()  // 刷新状态
}

// Protocol 层 (yhh.ts)
setDPI: (level, value, scrollDirection, reportRate) => {
  return [0x55, 0x0f, 0xae, 0x0a, 0x2f, ...]  // 具体协议编码
}
```

## 8. 关键文件索引

| 文件                       | 重要性 | 说明                               |
| -------------------------- | ------ | ---------------------------------- |
| `protocols/index.ts`       | ★★★    | 协议接口定义，新协议必须实现此接口 |
| `protocols/registry.ts`    | ★★★    | 协议注册，新协议需要在此注册       |
| `protocols/yhh.ts`         | ★★☆    | YHH 协议实现，可作为新协议参考     |
| `composables/useWebHID.ts` | ★★★    | WebHID 核心服务，一般不需要修改    |
| `config/buttonMappings.ts` | ★★☆    | 按键映射配置，可能需要适配         |
| `main/index.ts`            | ★☆☆    | 主进程，可能需要修改设备筛选逻辑   |
