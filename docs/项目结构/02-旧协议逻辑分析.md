# 旧协议逻辑分析与分类标注

## 1. 概述

本文档对现有 YHH 鼠标协议相关代码进行分析，标注各部分在新协议对接时的处理方式。

## 2. 分类标准

| 标签 | 含义 | 处理方式 |
|------|------|----------|
| 🟢 **可直接复用** | 与协议无关的通用代码 | 无需修改 |
| 🔴 **必须替换** | 与 YHH 协议强耦合的代码 | 需要重新实现 |
| 🟡 **可能需要适配** | 依赖协议特性的代码 | 根据新协议特性调整 |
| ⚠️ **高风险区域** | 容易出错或影响范围大的代码 | 需要特别注意 |

---

## 3. 协议层分析 (`src/renderer/src/protocols/`)

### 3.1 `index.ts` - 协议接口定义

| 代码区域 | 分类 | 说明 |
|----------|------|------|
| `DeviceProtocol` 接口 | 🟢 可直接复用 | 通用协议接口，新协议需实现此接口 |
| `ConnectionMode` 类型 | 🟢 可直接复用 | 连接模式定义 |
| `detectConnectionMode()` | 🟡 可能需要适配 | 依赖产品名称判断，新设备可能有不同命名 |

**详细分析**:

```typescript
// 🟢 可直接复用 - 协议接口定义
export interface DeviceProtocol {
  name: string
  identify: (device: HIDDevice) => boolean
  commands: { ... }
  parsers: { ... }
  features?: { ... }
}

// 🟡 可能需要适配 - 连接模式检测
export function detectConnectionMode(device: HIDDevice): ConnectionMode {
  const productName = device.productName?.toLowerCase() || ''
  // 新设备可能使用不同的产品名称标识无线模式
  if (productName.includes('receiver') || productName.includes('dongle')) {
    return '2.4g'
  }
  return 'usb'
}
```

### 3.2 `registry.ts` - 协议注册中心

| 代码区域 | 分类 | 说明 |
|----------|------|------|
| `protocolRegistry` 数组 | 🟡 可能需要适配 | 需要添加新协议到注册表 |
| `detectProtocol()` 函数 | 🟢 可直接复用 | 通用协议检测逻辑 |

**修改指南**:

```typescript
// 添加新协议时，只需修改此文件
import { newMouseProtocol } from './newMouse'

export const protocolRegistry: DeviceProtocol[] = [
  newMouseProtocol,  // 新协议 (优先级高)
  yhhProtocol,       // YHH 协议
  genericProtocol    // 通用协议 (默认)
]
```

### 3.3 `yhh.ts` - YHH 协议实现 ⚠️ 高风险区域

| 代码区域 | 分类 | 说明 |
|----------|------|------|
| 整个文件 | 🔴 必须替换 | YHH 专用协议，新协议需要完全重写 |
| `identify()` | 🔴 必须替换 | 设备识别逻辑 |
| `commands.*` | 🔴 必须替换 | 所有命令编码 |
| `parsers.*` | 🔴 必须替换 | 所有响应解析 |
| `features` | 🔴 必须替换 | 设备特性配置 |

**YHH 协议特征** (供参考):

```typescript
// YHH 协议特征 - 新协议可能完全不同
发送包头: 0x55
接收包头: 0xAA
ReportID: 0
数据长度: 64 字节
校验方式: 无 (或位于特定位置)
```

### 3.4 `generic.ts` - 通用协议

| 代码区域 | 分类 | 说明 |
|----------|------|------|
| 整个文件 | 🟢 可直接复用 | 作为默认回退协议 |

---

## 4. Service 层分析 (`src/renderer/src/composables/`)

### 4.1 `useWebHID.ts` - WebHID 核心服务 ⚠️ 高风险区域

#### 4.1.1 设备连接相关

| 函数 | 分类 | 说明 |
|------|------|------|
| `connectDevice()` | 🟢 可直接复用 | 通用设备连接逻辑 |
| `autoConnectDevice()` | 🟢 可直接复用 | 自动连接已授权设备 |
| `initializeDevice()` | 🟢 可直接复用 | 设备初始化流程 |
| `tryGetDeviceInfo()` | 🟡 可能需要适配 | 依赖协议的设备验证 |

#### 4.1.2 命令发送相关

| 函数 | 分类 | 说明 |
|------|------|------|
| `sendReport()` | 🟢 可直接复用 | 通用命令发送 |
| `waitForResponse()` | 🟡 可能需要适配 | 响应过滤逻辑依赖 0xAA 包头 |
| `sendCommandAndWait()` | 🟢 可直接复用 | 命令发送并等待响应 |

**⚠️ 高风险代码**:

```typescript
// 文件: useWebHID.ts, 行 148-153
// 🟡 可能需要适配 - 响应过滤逻辑
const handler = (event: HIDInputReportEvent) => {
  // Chrome bug workaround: 过滤掉不是以 0xAA 开头的响应
  // ⚠️ 新协议可能使用不同的响应包头!
  if (data[0] !== 0xaa) {
    return  // 忽略无效响应
  }
  // ...
}
```

#### 4.1.3 业务功能相关

| 函数 | 分类 | 说明 |
|------|------|------|
| `getDeviceInfo()` | 🟢 可直接复用 | 通过协议层获取设备信息 |
| `getBattery()` | 🟢 可直接复用 | 通过协议层获取电池状态 |
| `getCurrentReportRate()` | 🟢 可直接复用 | 通过协议层获取回报率 |
| `getCurrentDPI()` | 🟢 可直接复用 | 通过协议层获取 DPI |
| `setReportRate()` | 🟡 可能需要适配 | 参数传递依赖协议特性 |
| `setDPI()` | 🟡 可能需要适配 | 参数传递依赖协议特性 |
| `setScrollDirection()` | 🟡 可能需要适配 | 可选功能，依赖协议支持 |
| `setButtonMapping()` | 🟡 可能需要适配 | 按键数量可能不同 |
| `setMacro()` | 🟡 可能需要适配 | 宏格式可能不同 |

#### 4.1.4 DPI 变化监听

| 函数 | 分类 | 说明 |
|------|------|------|
| `setupDPIChangeListener()` | 🟡 可能需要适配 | 依赖协议的 reporters 配置 |
| `cleanupDPIChangeListener()` | 🟢 可直接复用 | 通用清理逻辑 |

**⚠️ 高风险代码**:

```typescript
// 文件: useWebHID.ts, 行 60-79
// 🟡 可能需要适配 - DPI 变化监听
dpiChangeListener = (event: HIDInputReportEvent) => {
  // 检查是否为 DPI 变化通知
  // ⚠️ 依赖协议的 reporters.isDPIChangeReport 实现
  if (protocol.reporters?.isDPIChangeReport?.(data)) {
    const dpiData = protocol.parsers.dpiChange?.(data)
    // ...
  }
}
```

### 4.2 `useMacroStorage.ts` - 宏存储管理

| 代码区域 | 分类 | 说明 |
|----------|------|------|
| 宏数据结构 | 🟢 可直接复用 | 通用宏事件格式 |
| `encodeMacroEvents()` | 🟡 可能需要适配 | 编码格式可能需要调整 |
| `getScancodeFromKeyName()` | 🟢 可直接复用 | 标准 HID 扫描码 |
| 本地存储逻辑 | 🟢 可直接复用 | 与协议无关 |

---

## 5. UI 层分析 (`src/renderer/src/components/`)

### 5.1 `BasicSettings.vue`

| 代码区域 | 分类 | 说明 |
|----------|------|------|
| 回报率设置 UI | 🟢 可直接复用 | 通过 features 动态配置 |
| DPI 设置 UI | 🟢 可直接复用 | 通过 features 动态配置 |
| 滚轮方向设置 UI | 🟡 可能需要适配 | 依赖 features.hasScrollDirection |

**关键代码**:

```typescript
// 🟢 可直接复用 - 通过协议特性动态配置
const reportRates = computed(() => {
  return deviceFeatures.value?.supportedReportRates || [125, 250, 500, 1000]
})

const supportedDPI = computed(() => {
  return deviceFeatures.value?.supportedDPI || []
})
```

### 5.2 `BacklightSettings.vue`

| 代码区域 | 分类 | 说明 |
|----------|------|------|
| 背光模式 UI | 🟢 可直接复用 | 通过 features.hasRGB 控制显示 |
| 颜色/亮度/频率 UI | 🟢 可直接复用 | 通用 UI 组件 |

### 5.3 `ButtonMapping.vue`

| 代码区域 | 分类 | 说明 |
|----------|------|------|
| 鼠标示意图 | 🟡 可能需要适配 | 按键数量/位置可能不同 |
| 按键功能选择 | 🟢 可直接复用 | 通用功能列表 |
| 宏绑定 UI | 🟢 可直接复用 | 通用宏管理 |
| `uiToDeviceIndex` 映射 | 🔴 必须替换 | YHH 特定的按键索引映射 |

**⚠️ 高风险代码**:

```typescript
// 文件: ButtonMapping.vue, 行 402
// 🔴 必须替换 - YHH 特定的按键索引映射
const uiToDeviceIndex = [0, 1, 2, 4, 3]  // UI索引 → 设备索引
// ⚠️ 新设备的按键索引映射可能完全不同!
```

### 5.4 `DeviceInfo.vue`

| 代码区域 | 分类 | 说明 |
|----------|------|------|
| 整个组件 | 🟢 可直接复用 | 通用设备信息展示 |

---

## 6. 配置层分析 (`src/renderer/src/config/`)

### 6.1 `buttonMappings.ts`

| 代码区域 | 分类 | 说明 |
|----------|------|------|
| `ButtonType` 枚举 | 🟢 可直接复用 | 通用按键类型 |
| `mouseButtons` | 🟡 可能需要适配 | 按键编码可能不同 |
| `multimediaButtons` | 🟡 可能需要适配 | 多媒体键编码可能不同 |
| `keyboardScancodes` | 🟢 可直接复用 | 标准 HID 扫描码 |
| `defaultButtonMappings` | 🔴 必须替换 | YHH 特定的默认映射 |

**⚠️ 高风险代码**:

```typescript
// 文件: buttonMappings.ts, 行 465-474
// 🔴 必须替换 - YHH 特定的默认按键映射
export const defaultButtonMappings: number[][] = [
  [0x20, 0x01, 0x00, 0x00],  // 左键
  [0x20, 0x02, 0x00, 0x00],  // 右键
  // ... 这些编码是 YHH 协议特定的!
]
```

---

## 7. 主进程分析 (`src/main/index.ts`)

| 代码区域 | 分类 | 说明 |
|----------|------|------|
| 窗口创建 | 🟢 可直接复用 | 通用 Electron 配置 |
| 权限处理器 | 🟢 可直接复用 | 通用 HID 权限 |
| 设备选择处理 | 🟡 可能需要适配 | 硬编码了 YHH 的 VID/PID |

**⚠️ 高风险代码**:

```typescript
// 文件: main/index.ts, 行 61-64
// 🟡 可能需要适配 - 硬编码的设备 VID/PID
const targetDevice = details.deviceList.find(
  (device) => device.vendorId === 0xa8a4 && device.productId === 0x2255
)
// ⚠️ 新设备需要修改或移除此筛选逻辑!
```

---

## 8. 风险汇总

### 8.1 必须替换的代码 (🔴)

| 文件 | 位置 | 说明 |
|------|------|------|
| `protocols/yhh.ts` | 整个文件 | 需要创建新协议文件 |
| `config/buttonMappings.ts` | `defaultButtonMappings` | 默认按键映射 |
| `components/ButtonMapping.vue` | `uiToDeviceIndex` | 按键索引映射 |

### 8.2 可能需要适配的代码 (🟡)

| 文件 | 位置 | 说明 |
|------|------|------|
| `composables/useWebHID.ts` | `waitForResponse()` | 响应包头过滤 |
| `composables/useWebHID.ts` | `setupDPIChangeListener()` | DPI 监听 |
| `protocols/index.ts` | `detectConnectionMode()` | 连接模式检测 |
| `main/index.ts` | 设备选择处理 | VID/PID 筛选 |
| `config/buttonMappings.ts` | 按键编码 | 功能键编码 |

### 8.3 高风险区域 (⚠️)

1. **响应包头过滤** - `useWebHID.ts:148-153`
   - 当前硬编码 `0xAA` 作为有效响应标识
   - 新协议可能使用不同的响应包头

2. **按键索引映射** - `ButtonMapping.vue:402`
   - YHH 设备的按键 4 和 5 在数组中位置对调
   - 新设备可能有不同的映射关系

3. **设备 VID/PID** - `main/index.ts:61-64`
   - 硬编码了 YHH 设备的 VID/PID
   - 新设备需要修改此处

---

## 9. 新协议对接检查清单

### 9.1 必做项

- [ ] 创建新协议文件 `protocols/newMouse.ts`
- [ ] 实现 `DeviceProtocol` 接口的所有方法
- [ ] 在 `registry.ts` 中注册新协议
- [ ] 更新 `defaultButtonMappings` (如果按键编码不同)
- [ ] 更新 `uiToDeviceIndex` (如果按键索引不同)

### 9.2 可能需要做

- [ ] 修改 `waitForResponse()` 中的响应包头过滤
- [ ] 修改 `main/index.ts` 中的设备 VID/PID 筛选
- [ ] 调整 `detectConnectionMode()` 的判断逻辑
- [ ] 更新按键功能编码 (如果不同)

### 9.3 验证项

- [ ] 设备连接正常
- [ ] 设备信息读取正确
- [ ] DPI 设置/读取正常
- [ ] 回报率设置/读取正常
- [ ] 按键映射设置/读取正常
- [ ] 宏功能正常 (如果支持)
- [ ] 背光功能正常 (如果支持)
