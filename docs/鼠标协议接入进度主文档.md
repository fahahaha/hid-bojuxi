# 鼠标协议接入进度主文档

> 版本: 1.0.0
> 创建日期: 2026-01-05
> 最后更新: 2026-01-14 (第四次更新)

---

## AI 执行路线指导语（Claude Code 必读）

```
【重要提示 - 每次 /clear 后请先阅读此文档】

你正在协助开发一个游戏鼠标驱动程序，当前任务是将博巨矽（Bojuxi）鼠标协议对接到现有的 WebHID Demo 项目中。

核心工作原则：
1. 本文档是你的工作入口和进度追踪中心，每次会话开始请先阅读本文档
2. 当前项目原本是 YHH 鼠标的 Demo，现在要适配博巨矽新协议
3. YHH 鼠标协议将被舍弃，可以不考虑其兼容性
4. UI 可以根据新协议需求进行修改（如 DPI 多档位设置等）
5. 尽量保持原有的架构和代码风格
6. 新协议应创建独立的协议文件（如 bojuxi.ts）

工作流程：
1. 查看本文档的"当前状态"和"下一步建议执行任务"
2. 找到状态为"进行中"的模块，继续从中断点执行
3. 若无进行中任务，按"下一步建议"开始新模块
4. 完成一个功能点后，询问用户是否测试通过
5. 用户确认后，更新本文档的模块状态为"完成"
6. 用户可能会 /clear 清除上下文，然后继续下一个模块

关键文档位置：
- 协议文档目录: docs/协议文档/
- 协议总索引: docs/协议文档/协议总索引.md
- 项目架构说明: docs/项目结构/01-项目整体架构说明.md
- 协议适配方案: docs/项目结构/03-协议适配层设计方案.md

代码关键位置：
- 协议层: src/renderer/src/protocols/
- 服务层: src/renderer/src/composables/useWebHID.ts
- UI组件: src/renderer/src/components/
- 主进程: src/main/index.ts（设备筛选逻辑）
```

---

## 1. 项目目标声明

### 1.1 总体目标

将博巨矽（Bojuxi）游戏鼠标 HID 协议完整对接到现有 WebHID Demo 项目中，实现以下功能：

- 设备连接与识别
- 基础设置配置（回报率、DPI 多档位、滚轮方向）
- 按键映射自定义
- 宏功能配置
- 设备信息显示
- 电池状态显示（无线设备）
- 恢复出厂设置

### 1.2 技术目标

- 创建独立的博巨矽协议文件 `bojuxi.ts`
- 适配 UI 以支持新协议特性（如 DPI 7档位独立设置）
- 保持现有架构（UI层 → Service层 → Protocol层）
- 代码风格与现有项目保持一致

### 1.3 协议规格

- **有线 VID/PID**: 0x1A86 / 0x8312
- **无线 VID/PID**: 0x1A86 / 0x8300
- **数据包长度**: 64 字节
- **发送包头**: 0xBA
- **正常响应包头**: 0x5A
- **异常响应包头**: 0x5B

---

## 2. 当前状态

### 2.1 整体进度

| 阶段               | 状态   | 完成度 |
| ------------------ | ------ | ------ |
| 第一阶段：基础设施 | 已完成 | 100%   |
| 第二阶段：核心功能 | 已完成 | 100%   |
| 第三阶段：扩展功能 | 已完成 | 100%   |
| 第四阶段：系统功能 | 已完成 | 100%   |

### 2.2 当前执行模块

- **模块**: 全部完成
- **步骤**: 无
- **阻塞原因**: 无

### 2.3 最近完成

- ✅ 创建 bojuxi.ts 协议文件框架（含错误码、按键配置格式常量）
- ✅ 修改主进程设备筛选逻辑（优先识别博巨矽鼠标）
- ✅ 注册博巨矽协议到 registry
- ✅ 修改 useWebHID.ts 支持博巨矽响应包头（0x5A/0x5B）
- ✅ 实现 M05 设备信息获取协议
- ✅ 实现 M06 电池信息读取协议
- ✅ 实现 M02 基础设置读取协议（回报率、DPI、滚轮方向、按键映射）
- ✅ 实现 M01 基础设置配置 - 回报率设置
- ✅ 实现 M01 基础设置配置 - DPI 多档位设置 + UI 改造
- ✅ 实现 M01 基础设置配置 - 滚轮方向设置
- ✅ 修复设置命令响应消费问题（sendReport 改为 sendCommandAndWait）
- ✅ 实现 M01 基础设置配置 - 按键映射（鼠标按键、DPI功能、多媒体键、键盘键）
- ✅ 更新 buttonMappings.ts 适配博巨矽协议4字节格式
- ✅ 更新 ButtonMapping.vue 添加 DPI 键显示和 DPI 功能标签页
- ✅ 更新国际化文件支持按键相关翻译
- ✅ **第二阶段全部完成（除宏管理外的基础设置对接和UI修改）**
- ✅ 更新 useMacroStorage.ts - 添加 Macro Code 键码映射和博巨矽协议编码
- ✅ 更新 useWebHID.ts - 实现博巨矽协议的宏配置多帧传输
- ✅ 更新 ButtonMapping.vue 中的宏管理 UI - 适配博巨矽协议限制
- ✅ 删除未使用的 MacroManagement.vue 组件
- ✅ **第三阶段宏配置联调测试通过**
- ✅ 实现 M07 恢复出厂设置 - 协议实现（bojuxi.ts 添加 factoryReset 命令）
- ✅ 实现 M07 恢复出厂设置 - useWebHID.ts 添加 factoryReset 方法
- ✅ 实现 M07 恢复出厂设置 - DeviceInfo.vue 调用 factoryReset 并清除宏缓存
- ✅ **第四阶段恢复出厂设置完成**

---

## 3. 模块任务列表

### 第一阶段：基础设施搭建

| 序号 | 模块     | 任务描述                    | 状态 | 当前步骤 | 联调验证  |
| ---- | -------- | --------------------------- | ---- | -------- | --------- |
| 0.1  | 基础常量 | 创建错误码定义（A02）       | 完成 | -        | ✅        |
| 0.2  | 基础常量 | 创建按键配置格式定义（D01） | 完成 | -        | ✅        |
| 0.3  | 协议框架 | 创建 bojuxi.ts 协议文件框架 | 完成 | -        | ✅        |
| 0.4  | 设备识别 | 修改主进程设备筛选逻辑      | 完成 | -        | ⏳ 待测试 |

### 第二阶段：核心功能实现

| 序号 | 模块 | 任务描述                   | 状态   | 当前步骤     | 联调验证 |
| ---- | ---- | -------------------------- | ------ | ------------ | -------- |
| 1.1  | M05  | 设备信息获取 - 协议实现    | 完成   | -            | ✅       |
| 1.2  | M05  | 设备信息获取 - UI 显示     | 完成   | 复用现有UI   | ✅       |
| 1.3  | M06  | 电池信息读取 - 协议实现    | 完成   | -            | ✅       |
| 1.4  | M06  | 电池信息读取 - UI 显示     | 完成   | 复用现有UI   | ✅       |
| 2.1  | M02  | 基础设置读取 - 协议实现    | 完成   | -            | ✅       |
| 2.2  | M02  | 基础设置读取 - 状态同步    | 完成   | 复用现有逻辑 | ✅       |
| 3.1  | M01  | 基础设置配置 - 回报率      | 完成   | -            | ✅       |
| 3.2  | M01  | 基础设置配置 - DPI 多档位  | 完成   | -            | ✅       |
| 3.3  | M01  | 基础设置配置 - DPI UI 改造 | 完成   | -            | ✅       |
| 3.4  | M01  | 基础设置配置 - 滚轮方向    | 完成   | -            | ✅       |
| 3.5  | M01  | 基础设置配置 - 按键映射    | 完成   | -            | ✅       |
| 3.6  | M01  | 基础设置配置 - 按键映射 UI | 完成   | -            | ✅       |

### 第三阶段：扩展功能实现

| 序号 | 模块 | 任务描述          | 状态   | 当前步骤       | 联调验证 |
| ---- | ---- | ----------------- | ------ | -------------- | -------- |
| 4.1  | M03  | 宏配置 - 协议实现 | 完成   | -              | ✅       |
| 4.2  | M03  | 宏配置 - 多帧传输 | 完成   | -              | ✅       |
| 4.3  | M03  | 宏配置 - UI 适配  | 完成   | -              | ✅       |

### 第四阶段：系统功能实现

| 序号 | 模块 | 任务描述                   | 状态   | 当前步骤 | 联调验证 |
| ---- | ---- | -------------------------- | ------ | -------- | -------- |
| 5.1  | M07  | 恢复出厂设置 - 协议实现    | 完成   | -        | ⏳       |
| 5.2  | M07  | 恢复出厂设置 - UI 确认流程 | 完成   | -        | ⏳       |

---

## 4. 模块详细状态

### 4.1 M05 - 设备信息获取

**协议文档**: [M05-设备信息获取](协议文档/03-系统模块/M05-设备信息获取.md)

**功能说明**:

- 命令码: 0xA5
- 获取设备编号、固件版本、传感器型号
- 获取 DPI 范围（min/max/step）
- 获取 LOD 范围

**实现步骤**:

1. [ ] 在 bojuxi.ts 中实现 getDeviceInfo 命令
2. [ ] 实现响应解析器 parseDeviceInfo
3. [ ] 在 useWebHID.ts 中调用并存储设备信息
4. [ ] 更新 DeviceInfo.vue 显示新字段
5. [ ] 根据 DPI 范围动态限制 UI 输入

**当前进度**: 未开始
**阻塞原因**: 无

---

### 4.2 M06 - 电池信息读取

**协议文档**: [M06-电池信息读取](协议文档/03-系统模块/M06-电池信息读取.md)

**功能说明**:

- 命令码: 0xA6
- 获取充电状态、电压、电量百分比
- 适用于无线鼠标

**实现步骤**:

1. [ ] 在 bojuxi.ts 中实现 getBattery 命令
2. [ ] 实现响应解析器 parseBattery
3. [ ] 在 useWebHID.ts 中添加电池状态轮询
4. [ ] 更新 UI 显示电池状态

**当前进度**: 未开始
**阻塞原因**: 无

---

### 4.3 M02 - 基础设置读取

**协议文档**: [M02-基础设置读取](协议文档/01-核心模块/M02-基础设置读取.md)

**功能说明**:

- 命令码: 0xA2
- 读取当前回报率、DPI 档位、按键映射等
- 用于初始化时同步设备状态

**实现步骤**:

1. [ ] 在 bojuxi.ts 中实现 getBasicSettings 命令
2. [ ] 实现响应解析器 parseBasicSettings
3. [ ] 解析 DPI 7档位数据
4. [ ] 解析按键映射数据
5. [ ] 同步到 UI 状态

**当前进度**: 未开始
**阻塞原因**: 无

---

### 4.4 M01 - 基础设置配置

**协议文档**: [M01-基础设置配置](协议文档/01-核心模块/M01-基础设置配置.md)

**功能说明**:

- 命令码: 0xA1
- 配置回报率、DPI、按键映射、滚轮方向
- 数据长度固定 60 字节

**实现步骤**:

1. [ ] 实现 setBasicSettings 命令构建
2. [ ] 实现回报率设置
3. [ ] 实现 DPI 多档位设置
4. [ ] 改造 DPI UI（从下拉选择改为多档位编辑）
5. [ ] 实现滚轮方向设置
6. [ ] 实现按键映射设置
7. [ ] 改造按键映射 UI
8. [ ] 实现 ACK 响应校验
9. [ ] 实现配置后读取验证

**当前进度**: 未开始
**阻塞原因**: 无

---

### 4.5 M03 - 宏配置

**协议文档**: [M03-宏配置](协议文档/02-功能模块/M03-宏配置.md)

**功能说明**:

- 命令码: 0xA3
- 支持 10 个宏，每个最多 340 个动作
- 支持多帧传输

**实现步骤**:

1. [ ] 实现宏数据编码
2. [ ] 实现多帧传输逻辑
3. [ ] 实现宏动作格式（3字节/6字节）
4. [ ] 适配宏管理 UI
5. [ ] 实现宏绑定到按键

**当前进度**: 未开始
**阻塞原因**: 无

---

### 4.6 M07 - 恢复出厂设置

**协议文档**: [M07-恢复出厂设置](协议文档/03-系统模块/M07-恢复出厂设置.md)

**功能说明**:

- 命令码: 0xA7
- 重置所有配置到出厂状态

**实现步骤**:

1. [ ] 实现 factoryReset 命令
2. [ ] 添加确认对话框
3. [ ] 重置后重新读取配置

**当前进度**: 未开始
**阻塞原因**: 无

---

## 5. 依赖关系说明

```
┌─────────────────────────────────────────────────────────────┐
│                      依赖关系图                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  [0.1 错误码] ──┬──────────────────────────────────────┐    │
│  [0.2 按键格式] ┤                                      │    │
│  [0.3 协议框架] ┤                                      │    │
│  [0.4 设备识别] ┘                                      │    │
│        │                                               │    │
│        ▼                                               │    │
│  [1.1 M05 设备信息] ◄─────────────────────────────┐    │    │
│        │                                          │    │    │
│        ├──► [1.2 M05 UI]                          │    │    │
│        │                                          │    │    │
│        ▼                                          │    │    │
│  [1.3 M06 电池] ──► [1.4 M06 UI]                  │    │    │
│        │                                          │    │    │
│        ▼                                          │    │    │
│  [2.1 M02 读取] ──► [2.2 M02 状态同步]            │    │    │
│        │                                          │    │    │
│        ▼                                          │    │    │
│  [3.1~3.6 M01 配置] ◄─────────────────────────────┘    │    │
│        │                                               │    │
│        ▼                                               │    │
│  [4.1~4.3 M03 宏] ◄── 需要 M01 按键绑定支持            │    │
│        │                                               │    │
│        ▼                                               │    │
│  [5.1~5.2 M07 恢复出厂]                                │    │
│                                                        │    │
└────────────────────────────────────────────────────────┘
```

### 关键依赖说明

1. **基础设施 → 所有模块**
   - 错误码定义、按键格式定义是所有模块的基础
   - 协议框架文件是所有协议实现的载体

2. **M05 → M01/M02**
   - M05 获取的 DPI 范围用于限制 M01 的 DPI 设置
   - M05 应在设备连接后首先调用

3. **M02 → M01**
   - M02 读取当前配置作为 M01 修改的基准
   - 避免覆盖未修改的配置项

4. **M01 → M03**
   - 宏绑定到按键需要通过 M01 设置按键类型为 0x07
   - M03 配置宏数据后，需要 M01 绑定才能生效

---

## 6. 下一步建议执行任务

### 推荐执行顺序

**第一步：基础设施搭建**

1. 创建 `src/renderer/src/protocols/bojuxi.ts` 协议文件框架
2. 创建错误码常量定义
3. 创建按键配置格式常量定义
4. 修改 `src/main/index.ts` 设备筛选逻辑（VID: 0x1A86, PID: 0x8312/0x8300）

**第二步：设备信息获取（M05）**

1. 实现 M05 命令和解析器
2. 更新 DeviceInfo.vue 显示
3. 联调验证

**第三步：基础设置读取（M02）**

1. 实现 M02 命令和解析器
2. 同步状态到 UI
3. 联调验证

**第四步：基础设置配置（M01）**

1. 实现回报率设置
2. 实现 DPI 多档位设置 + UI 改造
3. 实现滚轮方向设置
4. 实现按键映射设置 + UI 改造
5. 逐项联调验证

**第五步：电池信息（M06）**

1. 实现 M06 命令和解析器
2. 更新 UI 显示
3. 联调验证

**第六步：宏配置（M03）**

1. 实现宏数据编码和多帧传输
2. 适配宏管理 UI
3. 联调验证

**第七步：恢复出厂设置（M07）**

1. 实现 M07 命令
2. 添加确认流程
3. 联调验证

---

## 7. 执行路线指导语

### 开始新模块时

```
1. 阅读本文档，确认当前要执行的模块
2. 阅读对应的协议文档（docs/协议文档/）
3. 查看现有代码结构（protocols/yhh.ts 作为参考）
4. 按照模块详细状态中的步骤逐步实现
5. 每完成一个步骤，在本文档中标记 [x]
```

### 完成功能点后

```
1. 告知用户当前功能点已完成
2. 询问用户是否进行测试
3. 等待用户测试反馈
4. 若测试通过，更新本文档：
   - 将模块状态改为"完成"
   - 将联调验证改为 ✅
   - 更新"当前状态"部分
5. 若测试失败，记录问题并继续修复
```

### 用户 /clear 后继续

```
1. 首先阅读本文档
2. 查看"当前状态"部分，找到进行中的任务
3. 查看对应模块的"当前步骤"
4. 从中断点继续执行
5. 若无进行中任务，查看"下一步建议执行任务"
```

---

## 8. UI 改造说明

### 8.1 DPI 设置改造

**原有设计（YHH）**:

- 下拉选择固定 DPI 值
- 单一 DPI 设置

**新设计（博巨矽）**:

- 支持 7 个 DPI 档位（0~6）
- 每个档位可独立设置 DPI 值（50~16000，步进 50）
- 可设置总档位数（1~7）
- 可设置当前激活档位
- 需要显示 DPI 范围（从 M05 获取）

### 8.2 按键映射改造

**原有设计（YHH）**:

- 基础按键映射

**新设计（博巨矽）**:

- 支持 9 种按键类型
- 支持键盘单键、组合键、鼠标按键、多媒体键
- 支持 DPI 按键、功能按键、宏绑定、滚轮
- 支持禁用按键
- 左键暂不开放修改

### 8.3 设备信息显示

**新增显示项**:

- 设备编号
- 固件版本
- 传感器型号
- DPI 范围
- LOD 范围

---

## 9. 变更记录

| 日期       | 版本  | 修改内容                                                                 | 修改人 |
| ---------- | ----- | ------------------------------------------------------------------------ | ------ |
| 2026-01-05 | 1.0.0 | 初版创建                                                                 | Claude |
| 2026-01-10 | 1.0.1 | 完成第二阶段基础设置（回报率、DPI、滚轮方向），按键映射待开发            | Claude |
| 2026-01-10 | 1.0.2 | 完成第二阶段全部功能（按键映射协议+UI），第二阶段100%完成                | Claude |
| 2026-01-10 | 1.0.3 | 完成第三阶段宏配置（协议实现、多帧传输、UI适配），待联调测试             | Claude |
| 2026-01-14 | 1.0.4 | 第三阶段宏配置联调测试通过，第三阶段100%完成                             | Claude |
| 2026-01-14 | 1.0.5 | 完成第四阶段恢复出厂设置（M07协议实现、UI确认流程、清除宏缓存）          | Claude |

---

## 10. 附录

### 10.1 协议命令速查

| 命令码 | 功能         | 数据长度 | 状态     |
| ------ | ------------ | -------- | -------- |
| 0xA1   | 配置基础设置 | 60       | 可用     |
| 0xA2   | 读取基础设置 | 4        | 可用     |
| 0xA3   | 配置宏       | 可变     | 可用     |
| 0xA4   | 读取宏       | -        | 暂不开发 |
| 0xA5   | 获取设备信息 | 2        | 可用     |
| 0xA6   | 读取电池信息 | 0        | 可用     |
| 0xA7   | 恢复出厂设置 | -        | 可用     |
| 0xA8   | 固件升级     | -        | 暂不开发 |

### 10.2 连接模式标识

| 值   | 含义         |
| ---- | ------------ |
| 0x8A | 无线（2.4G） |
| 0xFF | 有线 USB     |

### 10.3 响应包头

| 值   | 含义            |
| ---- | --------------- |
| 0x5A | 正常响应 (ACK)  |
| 0x5B | 异常响应 (NACK) |
