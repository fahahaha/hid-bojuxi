<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>通用游戏鼠标驱动</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"
      rel="stylesheet"
    />

    <!-- 配置Tailwind自定义颜色和字体 -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: '#165DFF',
              secondary: '#36CFC9',
              accent: '#722ED1',
              dark: '#1D2129',
              light: '#F2F3F5',
              success: '#00B42A',
              warning: '#FF7D00',
              danger: '#F53F3F',
              'gray-dark': '#4E5969',
              'gray-medium': '#86909C',
              'gray-light': '#C9CDD4'
            },
            fontFamily: {
              sans: ['Inter', 'system-ui', 'sans-serif']
            }
          }
        }
      }
    </script>

    <style type="text/tailwindcss">
      @layer utilities {
        .content-auto {
          content-visibility: auto;
        }
        .tab-active {
          @apply border-b-2 border-primary text-primary font-medium;
        }
        .card-hover {
          @apply transition-all duration-300 hover:shadow-lg hover:-translate-y-1;
        }
        .btn-primary {
          @apply bg-primary text-white px-4 py-2 rounded-md transition-all duration-200 hover:bg-primary/90 active:bg-primary/80 focus:outline-none focus:ring-2 focus:ring-primary/50;
        }
        .btn-secondary {
          @apply bg-white text-dark border border-gray-light px-4 py-2 rounded-md transition-all duration-200 hover:bg-light active:bg-gray-light focus:outline-none focus:ring-2 focus:ring-gray-medium/30;
        }
        .input-control {
          @apply border border-gray-light rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-200;
        }
        .setting-active {
          @apply bg-primary text-white border-primary;
        }
      }
    </style>
  </head>

  <body class="bg-gray-50 font-sans text-dark min-h-screen">
    <!-- 顶部导航栏 -->
    <header class="bg-white shadow-sm sticky top-0 z-50 transition-all duration-300">
      <div class="container mx-auto px-4 py-3 flex justify-between items-center">
        <div class="flex items-center space-x-3">
          <div class="w-10 h-10 bg-primary rounded-lg flex items-center justify-center">
            <i class="fa fa-mouse-pointer text-white text-xl"></i>
          </div>
          <h1 class="text-xl font-bold text-dark">通用游戏鼠标驱动</h1>
          <span class="text-gray-medium text-sm hidden md:inline-block">支持多种游戏鼠标</span>
        </div>

        <div class="flex items-center space-x-4">
          <div id="connectionStatus" class="flex items-center text-sm">
            <span class="w-2 h-2 rounded-full bg-danger mr-2"></span>
            <span>未连接设备</span>
          </div>
          <button id="connectBtn" class="btn-primary text-sm">
            <i class="fa fa-plug mr-1"></i> 连接设备
          </button>
        </div>
      </div>
    </header>

    <!-- 主内容区 -->
    <main class="container mx-auto px-4 py-6">
      <!-- 设备状态概览卡片 -->
      <div
        id="deviceOverview"
        class="bg-white rounded-xl shadow-sm p-5 mb-6 opacity-50 pointer-events-none transition-all duration-300"
      >
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div class="flex items-center space-x-3">
            <div class="w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center">
              <i class="fa fa-battery-three-quarters text-primary text-xl"></i>
            </div>
            <div>
              <p class="text-gray-medium text-sm">电池状态</p>
              <p id="batteryStatus" class="font-medium">--</p>
            </div>
          </div>

          <div class="flex items-center space-x-3">
            <div class="w-12 h-12 rounded-full bg-secondary/10 flex items-center justify-center">
              <i class="fa fa-refresh text-secondary text-xl"></i>
            </div>
            <div>
              <p class="text-gray-medium text-sm">当前回报率</p>
              <p id="currentReportRate" class="font-medium">--</p>
            </div>
          </div>

          <div class="flex items-center space-x-3">
            <div class="w-12 h-12 rounded-full bg-accent/10 flex items-center justify-center">
              <i class="fa fa-tachometer text-accent text-xl"></i>
            </div>
            <div>
              <p class="text-gray-medium text-sm">当前CPI</p>
              <p id="currentCPI" class="font-medium">--</p>
            </div>
          </div>

          <div class="flex items-center space-x-3">
            <div class="w-12 h-12 rounded-full bg-warning/10 flex items-center justify-center">
              <i class="fa fa-lightbulb-o text-warning text-xl"></i>
            </div>
            <div>
              <p class="text-gray-medium text-sm">背光模式</p>
              <p id="backlightMode" class="font-medium">--</p>
            </div>
          </div>
        </div>
      </div>

      <!-- 标签页导航 -->
      <div class="border-b border-gray-light mb-6">
        <div class="flex overflow-x-auto scrollbar-hide space-x-1 md:space-x-4">
          <button
            class="tab-btn tab-active px-4 py-3 text-sm md:text-base whitespace-nowrap"
            data-tab="basic"
          >
            <i class="fa fa-sliders mr-2"></i>基础设置
          </button>
          <button
            class="tab-btn px-4 py-3 text-sm md:text-base whitespace-nowrap"
            data-tab="backlight"
          >
            <i class="fa fa-lightbulb-o mr-2"></i>背光设置
          </button>
          <button
            class="tab-btn px-4 py-3 text-sm md:text-base whitespace-nowrap"
            data-tab="buttons"
          >
            <i class="fa fa-keyboard-o mr-2"></i>改键设置
          </button>
          <button class="tab-btn px-4 py-3 text-sm md:text-base whitespace-nowrap" data-tab="macro">
            <i class="fa fa-list-ol mr-2"></i>宏管理
          </button>
          <button
            class="tab-btn px-4 py-3 text-sm md:text-base whitespace-nowrap"
            data-tab="device"
          >
            <i class="fa fa-info-circle mr-2"></i>设备信息
          </button>
        </div>
      </div>

      <!-- 标签页内容 -->
      <div class="tab-contents">
        <!-- 1. 基础设置标签页 -->
        <div class="tab-content active" id="basic">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- 回报率设置 -->
            <div class="bg-white rounded-xl shadow-sm p-5 card-hover">
              <h3 class="text-lg font-semibold mb-4 flex items-center">
                <i class="fa fa-refresh text-secondary mr-2"></i>回报率设置
              </h3>
              <p class="text-gray-medium text-sm mb-4">
                调整鼠标的回报率，更高的回报率提供更流畅的光标移动
              </p>

              <div class="flex items-center justify-between">
                <div class="flex space-x-2">
                  <button
                    class="report-rate-btn px-4 py-2 rounded border transition-all duration-200"
                    data-rate="125"
                  >
                    125 Hz
                  </button>
                  <button
                    class="report-rate-btn px-4 py-2 rounded border transition-all duration-200"
                    data-rate="250"
                  >
                    250 Hz
                  </button>
                  <button
                    class="report-rate-btn px-4 py-2 rounded border transition-all duration-200"
                    data-rate="500"
                  >
                    500 Hz
                  </button>
                  <button
                    class="report-rate-btn px-4 py-2 rounded border transition-all duration-200"
                    data-rate="1000"
                  >
                    1000 Hz
                  </button>
                </div>
              </div>
            </div>

            <!-- CPI设置 -->
            <div class="bg-white rounded-xl shadow-sm p-5 card-hover">
              <h3 class="text-lg font-semibold mb-4 flex items-center">
                <i class="fa fa-tachometer text-accent mr-2"></i>CPI设置
              </h3>
              <p class="text-gray-medium text-sm mb-4">
                调整鼠标的灵敏度，CPI值越高，光标移动速度越快
              </p>

              <div class="space-y-6">
                <!-- 当前CPI档位 -->
                <div>
                  <div class="flex justify-between items-center mb-2">
                    <label class="text-sm text-gray-dark">当前CPI档位</label>
                    <span id="cpiLevelDisplay" class="text-sm font-medium">档位 4</span>
                  </div>
                  <div class="flex items-center">
                    <button
                      id="cpiMinus"
                      class="btn-secondary w-10 h-10 p-0 flex items-center justify-center"
                    >
                      <i class="fa fa-minus"></i>
                    </button>

                    <div class="mx-4 flex-1">
                      <div class="h-2 bg-gray-100 rounded-full relative">
                        <div
                          id="cpiLevelIndicator"
                          class="absolute top-0 bottom-0 w-1/7 bg-accent rounded-full"
                          style="left: 42.85%"
                        ></div>
                        <div class="absolute top-0 left-0 w-full flex justify-between px-[-8px]">
                          <span class="w-3 h-3 rounded-full bg-gray-light -mt-0.5"></span>
                          <span class="w-3 h-3 rounded-full bg-gray-light -mt-0.5"></span>
                          <span class="w-3 h-3 rounded-full bg-gray-light -mt-0.5"></span>
                          <span class="w-3 h-3 rounded-full bg-gray-light -mt-0.5"></span>
                          <span class="w-3 h-3 rounded-full bg-gray-light -mt-0.5"></span>
                          <span class="w-3 h-3 rounded-full bg-gray-light -mt-0.5"></span>
                          <span class="w-3 h-3 rounded-full bg-gray-light -mt-0.5"></span>
                        </div>
                      </div>
                      <div class="flex justify-between mt-1 text-xs text-gray-medium">
                        <span>1</span>
                        <span>2</span>
                        <span>3</span>
                        <span>4</span>
                        <span>5</span>
                        <span>6</span>
                        <span>7</span>
                      </div>
                    </div>

                    <button
                      id="cpiPlus"
                      class="btn-secondary w-10 h-10 p-0 flex items-center justify-center"
                    >
                      <i class="fa fa-plus"></i>
                    </button>
                  </div>
                </div>

                <!-- 自定义CPI值 -->
                <div>
                  <div class="flex justify-between items-center mb-2">
                    <label class="text-sm text-gray-dark">CPI值设置</label>
                    <span id="cpiValueDisplay" class="text-sm font-medium">2000</span>
                  </div>
                  <div class="space-y-2">
                    <input
                      type="range"
                      id="cpiSlider"
                      min="50"
                      max="16000"
                      step="50"
                      value="2000"
                      class="w-full h-2 bg-gray-100 rounded-lg appearance-none cursor-pointer accent-accent"
                    />
                    <div class="flex items-center">
                      <input
                        type="number"
                        id="customCPI"
                        min="50"
                        max="16000"
                        step="50"
                        value="2000"
                        class="input-control w-24"
                      />
                      <span class="mx-2 text-gray-medium">CPI</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 2. 背光设置标签页 -->
        <div class="tab-content hidden" id="backlight">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- 背光模式 -->
            <div class="bg-white rounded-xl shadow-sm p-5 card-hover md:col-span-1">
              <h3 class="text-lg font-semibold mb-4 flex items-center">
                <i class="fa fa-lightbulb-o text-warning mr-2"></i>背光模式
              </h3>
              <p class="text-gray-medium text-sm mb-4">选择鼠标的LED背光效果模式</p>

              <div class="space-y-3">
                <button
                  class="backlight-mode-btn w-full text-left px-4 py-3 rounded border flex items-center transition-all duration-200"
                  data-mode="0"
                >
                  <span class="w-3 h-3 rounded-full bg-gray-medium mr-3"></span>
                  <span>常灭</span>
                </button>
                <button
                  class="backlight-mode-btn w-full text-left px-4 py-3 rounded border flex items-center transition-all duration-200"
                  data-mode="1"
                >
                  <span class="w-3 h-3 rounded-full bg-white border border-gray-light mr-3"></span>
                  <span>常亮</span>
                </button>
                <button
                  class="backlight-mode-btn w-full text-left px-4 py-3 rounded border flex items-center transition-all duration-200"
                  data-mode="2"
                >
                  <span class="w-3 h-3 rounded-full bg-primary animate-pulse mr-3"></span>
                  <span>呼吸</span>
                </button>
                <button
                  class="backlight-mode-btn w-full text-left px-4 py-3 rounded border flex items-center transition-all duration-200"
                  data-mode="3"
                >
                  <span class="w-3 h-3 rounded-full bg-secondary mr-3"></span>
                  <span>APM模式</span>
                </button>
                <button
                  class="backlight-mode-btn w-full text-left px-4 py-3 rounded border flex items-center transition-all duration-200"
                  data-mode="4"
                >
                  <span
                    class="w-3 h-3 rounded-full bg-gradient-to-r from-red-500 via-green-500 to-blue-500 mr-3"
                  ></span>
                  <span>全光谱</span>
                </button>
              </div>
            </div>

            <!-- 背光颜色和亮度 -->
            <div class="bg-white rounded-xl shadow-sm p-5 card-hover md:col-span-2">
              <h3 class="text-lg font-semibold mb-4 flex items-center">
                <i class="fa fa-paint-brush text-primary mr-2"></i>背光颜色与亮度
              </h3>
              <p class="text-gray-medium text-sm mb-4">自定义鼠标背光的颜色和亮度</p>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- 颜色选择 -->
                <div>
                  <label class="block text-sm text-gray-dark mb-2">背光颜色</label>
                  <div class="grid grid-cols-6 gap-3 mb-4">
                    <button
                      class="color-btn w-full aspect-square rounded-full bg-red-500 transition-transform duration-200 hover:scale-110"
                      data-color="#FF3B30"
                    ></button>
                    <button
                      class="color-btn w-full aspect-square rounded-full bg-orange-500 transition-transform duration-200 hover:scale-110"
                      data-color="#FF9500"
                    ></button>
                    <button
                      class="color-btn w-full aspect-square rounded-full bg-yellow-400 transition-transform duration-200 hover:scale-110"
                      data-color="#FFCC00"
                    ></button>
                    <button
                      class="color-btn w-full aspect-square rounded-full bg-green-500 transition-transform duration-200 hover:scale-110"
                      data-color="#34C759"
                    ></button>
                    <button
                      class="color-btn w-full aspect-square rounded-full bg-blue-500 transition-transform duration-200 hover:scale-110"
                      data-color="#007AFF"
                    ></button>
                    <button
                      class="color-btn w-full aspect-square rounded-full bg-purple-500 transition-transform duration-200 hover:scale-110"
                      data-color="#AF52DE"
                    ></button>
                  </div>

                  <div class="flex items-center space-x-3">
                    <div id="selectedColorPreview" class="w-10 h-10 rounded-full bg-primary"></div>
                    <input
                      type="text"
                      id="colorHex"
                      value="#165DFF"
                      class="input-control flex-1"
                      placeholder="十六进制颜色值"
                    />
                    <input
                      type="color"
                      id="colorPicker"
                      value="#165DFF"
                      class="w-10 h-10 p-0 border-0 rounded"
                    />
                  </div>
                </div>

                <!-- 亮度和频率 -->
                <div>
                  <div class="mb-6">
                    <div class="flex justify-between items-center mb-2">
                      <label class="text-sm text-gray-dark">亮度</label>
                      <span id="brightnessValue" class="text-sm font-medium">80%</span>
                    </div>
                    <input
                      type="range"
                      id="brightnessSlider"
                      min="0"
                      max="100"
                      step="5"
                      value="80"
                      class="w-full h-2 bg-gray-100 rounded-lg appearance-none cursor-pointer accent-primary"
                    />
                  </div>

                  <div>
                    <div class="flex justify-between items-center mb-2">
                      <label class="text-sm text-gray-dark">呼吸频率</label>
                      <span id="frequencyValue" class="text-sm font-medium">中等</span>
                    </div>
                    <input
                      type="range"
                      id="frequencySlider"
                      min="1"
                      max="5"
                      step="1"
                      value="3"
                      class="w-full h-2 bg-gray-100 rounded-lg appearance-none cursor-pointer accent-primary"
                    />
                    <div class="flex justify-between mt-1 text-xs text-gray-medium">
                      <span>极慢</span>
                      <span>慢</span>
                      <span>中等</span>
                      <span>快</span>
                      <span>极快</span>
                    </div>
                  </div>
                </div>
              </div>

              <div class="mt-6 flex justify-end space-x-3">
                <button id="resetBacklight" class="btn-secondary">
                  <i class="fa fa-refresh mr-1"></i>重置
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- 3. 改键设置标签页 -->
        <div class="tab-content hidden" id="buttons">
          <div class="bg-white rounded-xl shadow-sm p-5 mb-6">
            <h3 class="text-lg font-semibold mb-4 flex items-center">
              <i class="fa fa-keyboard-o text-primary mr-2"></i>鼠标按键自定义
            </h3>
            <p class="text-gray-medium text-sm mb-6">
              自定义鼠标各按键的功能，可设置为单键、组合键、宏或其他功能
            </p>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
              <!-- 鼠标按键示意图 -->
              <div class="lg:col-span-1 flex justify-center items-center">
                <div class="relative w-64 h-128 bg-gray-100 rounded-full p-4">
                  <!-- 鼠标主体 -->
                  <div class="absolute inset-4 bg-gray-200 rounded-full overflow-hidden">
                    <!-- 按键标记 -->
                    <div
                      class="button-marker absolute w-12 h-8 bg-primary/20 rounded-md flex items-center justify-center cursor-pointer hover:bg-primary/30 transition-colors"
                      data-button="0"
                    >
                      <span class="text-xs font-medium">1</span>
                    </div>
                    <div
                      class="button-marker absolute w-12 h-8 bg-primary/20 rounded-md flex items-center justify-center cursor-pointer hover:bg-primary/30 transition-colors"
                      data-button="1"
                      style="left: 14px; top: 8px"
                    >
                      <span class="text-xs font-medium">2</span>
                    </div>
                    <div
                      class="button-marker absolute w-12 h-8 bg-primary/20 rounded-md flex items-center justify-center cursor-pointer hover:bg-primary/30 transition-colors"
                      data-button="2"
                      style="left: 28px; top: 0px"
                    >
                      <span class="text-xs font-medium">3</span>
                    </div>
                    <div
                      class="button-marker absolute w-6 h-16 bg-primary/20 rounded-md flex items-center justify-center cursor-pointer hover:bg-primary/30 transition-colors"
                      data-button="3"
                      style="left: 110px; top: 20px"
                    >
                      <span class="text-xs font-medium">4</span>
                    </div>
                    <div
                      class="button-marker absolute w-6 h-16 bg-primary/20 rounded-md flex items-center justify-center cursor-pointer hover:bg-primary/30 transition-colors"
                      data-button="4"
                      style="left: 130px; top: 20px"
                    >
                      <span class="text-xs font-medium">5</span>
                    </div>
                    <div
                      class="button-marker absolute w-20 h-6 bg-primary/20 rounded-md flex items-center justify-center cursor-pointer hover:bg-primary/30 transition-colors"
                      data-button="5"
                      style="left: 40px; top: 80px"
                    >
                      <span class="text-xs font-medium">6</span>
                    </div>
                    <div
                      class="button-marker absolute w-20 h-6 bg-primary/20 rounded-md flex items-center justify-center cursor-pointer hover:bg-primary/30 transition-colors"
                      data-button="6"
                      style="left: 40px; top: 90px"
                    >
                      <span class="text-xs font-medium">7</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- 按键功能设置 -->
              <div class="lg:col-span-2">
                <div id="buttonConfig" class="border rounded-xl p-5">
                  <div class="flex justify-between items-center mb-4">
                    <h4 class="font-medium" id="currentButtonName">左键（按键 1）</h4>
                    <button
                      id="resetButton"
                      class="text-sm text-gray-medium hover:text-primary transition-colors"
                    >
                      <i class="fa fa-refresh mr-1"></i>恢复默认
                    </button>
                  </div>

                  <div class="space-y-4">
                    <div>
                      <label class="block text-sm text-gray-dark mb-2">功能类型</label>
                      <select id="functionType" class="input-control w-full">
                        <option value="normal">默认功能</option>
                        <option value="single">单键</option>
                        <option value="combination">组合键</option>
                        <option value="macro">宏</option>
                        <option value="media">媒体控制</option>
                        <option value="windows">Windows功能</option>
                      </select>
                    </div>

                    <!-- 单键设置 -->
                    <div id="singleKeyConfig" class="hidden">
                      <label class="block text-sm text-gray-dark mb-2">选择按键</label>
                      <input
                        type="text"
                        id="singleKey"
                        class="input-control w-full"
                        placeholder="按下要设置的键"
                      />
                    </div>

                    <!-- 组合键设置 -->
                    <div id="combinationKeyConfig" class="hidden">
                      <label class="block text-sm text-gray-dark mb-2">组合键</label>
                      <div class="flex flex-wrap gap-2 mb-2">
                        <label class="inline-flex items-center">
                          <input type="checkbox" class="form-checkbox text-primary" value="ctrl" />
                          <span class="ml-1 text-sm">Ctrl</span>
                        </label>
                        <label class="inline-flex items-center">
                          <input type="checkbox" class="form-checkbox text-primary" value="shift" />
                          <span class="ml-1 text-sm">Shift</span>
                        </label>
                        <label class="inline-flex items-center">
                          <input type="checkbox" class="form-checkbox text-primary" value="alt" />
                          <span class="ml-1 text-sm">Alt</span>
                        </label>
                        <label class="inline-flex items-center">
                          <input type="checkbox" class="form-checkbox text-primary" value="win" />
                          <span class="ml-1 text-sm">Win</span>
                        </label>
                      </div>
                      <input
                        type="text"
                        id="combinationKey"
                        class="input-control w-full"
                        placeholder="按下要设置的键"
                      />
                    </div>

                    <!-- 宏设置 -->
                    <div id="macroConfig" class="hidden">
                      <label class="block text-sm text-gray-dark mb-2">选择宏</label>
                      <select id="macroSelect" class="input-control w-full">
                        <option value="0">宏 1</option>
                        <option value="1">宏 2</option>
                        <option value="2">宏 3</option>
                        <option value="3">宏 4</option>
                        <option value="4">宏 5</option>
                      </select>
                    </div>

                    <!-- 媒体控制设置 -->
                    <div id="mediaConfig" class="hidden">
                      <label class="block text-sm text-gray-dark mb-2">媒体功能</label>
                      <select id="mediaSelect" class="input-control w-full">
                        <option value="play">播放/暂停</option>
                        <option value="stop">停止</option>
                        <option value="next">下一曲</option>
                        <option value="prev">上一曲</option>
                        <option value="volup">音量+</option>
                        <option value="voldown">音量-</option>
                        <option value="mute">静音</option>
                      </select>
                    </div>

                    <!-- Windows功能设置 -->
                    <div id="windowsConfig" class="hidden">
                      <label class="block text-sm text-gray-dark mb-2">Windows功能</label>
                      <select id="windowsSelect" class="input-control w-full">
                        <option value="task">任务视图</option>
                        <option value="search">搜索</option>
                        <option value="lock">锁定</option>
                        <option value="menu">开始菜单</option>
                        <option value="desktop">显示桌面</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 4. 宏管理标签页 -->
        <div class="tab-content hidden" id="macro">
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- 宏列表 -->
            <div class="bg-white rounded-xl shadow-sm p-5 card-hover">
              <h3 class="text-lg font-semibold mb-4 flex items-center">
                <i class="fa fa-list-ol text-primary mr-2"></i>宏列表
              </h3>
              <p class="text-gray-medium text-sm mb-4">管理您的宏，最多可保存10组宏</p>

              <div class="space-y-2 mb-4">
                <button
                  class="macro-item w-full text-left px-4 py-3 rounded border flex justify-between items-center transition-all duration-200"
                  data-index="0"
                >
                  <span>宏 1</span>
                  <span class="text-xs text-gray-medium">0个动作</span>
                </button>
                <button
                  class="macro-item w-full text-left px-4 py-3 rounded border flex justify-between items-center transition-all duration-200"
                  data-index="1"
                >
                  <span>宏 2</span>
                  <span class="text-xs text-gray-medium">0个动作</span>
                </button>
                <button
                  class="macro-item w-full text-left px-4 py-3 rounded border flex justify-between items-center transition-all duration-200"
                  data-index="2"
                >
                  <span>宏 3</span>
                  <span class="text-xs text-gray-medium">0个动作</span>
                </button>
                <button
                  class="macro-item w-full text-left px-4 py-3 rounded border flex justify-between items-center transition-all duration-200"
                  data-index="3"
                >
                  <span>宏 4</span>
                  <span class="text-xs text-gray-medium">0个动作</span>
                </button>
                <button
                  class="macro-item w-full text-left px-4 py-3 rounded border flex justify-between items-center transition-all duration-200"
                  data-index="4"
                >
                  <span>宏 5</span>
                  <span class="text-xs text-gray-medium">0个动作</span>
                </button>
              </div>

              <div class="space-y-3">
                <button id="newMacro" class="btn-secondary w-full">
                  <i class="fa fa-plus mr-1"></i>新建宏
                </button>
                <button id="deleteMacro" class="btn-secondary w-full text-danger border-danger/30">
                  <i class="fa fa-trash mr-1"></i>删除选中宏
                </button>
              </div>
            </div>

            <!-- 宏录制和设置 -->
            <div class="lg:col-span-2 space-y-6">
              <!-- 录制控制 -->
              <div class="bg-white rounded-xl shadow-sm p-5 card-hover">
                <h3 class="text-lg font-semibold mb-4 flex items-center">
                  <i class="fa fa-circle-o-notch text-accent mr-2"></i>宏录制
                </h3>

                <div class="flex flex-wrap gap-3 mb-4">
                  <button id="startRecord" class="btn-primary">
                    <i class="fa fa-circle mr-1"></i>开始录制
                  </button>
                  <button id="stopRecord" class="btn-secondary" disabled>
                    <i class="fa fa-stop mr-1"></i>停止录制
                  </button>
                  <button id="cancelRecord" class="btn-secondary" disabled>
                    <i class="fa fa-times mr-1"></i>取消录制
                  </button>
                  <button id="testMacro" class="btn-secondary">
                    <i class="fa fa-play mr-1"></i>测试宏
                  </button>
                </div>

                <div
                  id="recordingStatus"
                  class="hidden p-3 bg-accent/10 rounded-md text-sm flex items-center"
                >
                  <i class="fa fa-circle text-accent animate-pulse mr-2"></i>
                  <span>正在录制... 请执行您的操作，完成后点击"停止录制"</span>
                </div>
              </div>

              <!-- 宏设置 -->
              <div class="bg-white rounded-xl shadow-sm p-5 card-hover">
                <div class="flex justify-between items-center mb-4">
                  <h3 class="text-lg font-semibold flex items-center">
                    <i class="fa fa-cog text-primary mr-2"></i>宏设置
                  </h3>
                  <div>
                    <button id="saveMacro" class="btn-primary">
                      <i class="fa fa-save mr-1"></i>保存宏
                    </button>
                  </div>
                </div>

                <div class="space-y-4">
                  <div>
                    <label class="block text-sm text-gray-dark mb-2">宏名称</label>
                    <input
                      type="text"
                      id="macroName"
                      class="input-control w-full"
                      placeholder="输入宏名称"
                    />
                  </div>

                  <div>
                    <label class="block text-sm text-gray-dark mb-2">循环次数</label>
                    <select id="loopCount" class="input-control w-full">
                      <option value="1">1次</option>
                      <option value="2">2次</option>
                      <option value="3">3次</option>
                      <option value="5">5次</option>
                      <option value="10">10次</option>
                      <option value="0">无限循环</option>
                    </select>
                  </div>

                  <div>
                    <label class="block text-sm text-gray-dark mb-2">宏动作列表</label>
                    <div id="macroActions" class="border rounded-md max-h-60 overflow-y-auto">
                      <div class="p-4 text-center text-gray-medium text-sm">
                        录制宏动作后将显示在这里
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 5. 设备信息标签页 -->
        <div class="tab-content hidden" id="device">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- 设备信息 -->
            <div class="bg-white rounded-xl shadow-sm p-5 card-hover">
              <h3 class="text-lg font-semibold mb-4 flex items-center">
                <i class="fa fa-info-circle text-primary mr-2"></i>设备信息
              </h3>

              <div class="space-y-4">
                <div class="flex justify-between pb-3 border-b border-gray-100">
                  <span class="text-gray-dark">设备名称</span>
                  <span id="deviceName" class="font-medium">--</span>
                </div>
                <div class="flex justify-between pb-3 border-b border-gray-100">
                  <span class="text-gray-dark">设备型号</span>
                  <span id="deviceModel" class="font-medium">--</span>
                </div>
                <div class="flex justify-between pb-3 border-b border-gray-100">
                  <span class="text-gray-dark">固件版本</span>
                  <span id="firmwareVersion" class="font-medium">--</span>
                </div>
                <div class="flex justify-between pb-3 border-b border-gray-100">
                  <span class="text-gray-dark">连接方式</span>
                  <span id="connectionType" class="font-medium">--</span>
                </div>
                <div class="flex justify-between pb-3 border-b border-gray-100">
                  <span class="text-gray-dark">VID/PID</span>
                  <span id="vidPid" class="font-medium">--</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-dark">设备协议</span>
                  <span id="deviceProtocol" class="font-medium">--</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-dark">设备状态</span>
                  <span id="deviceStatusDetail" class="font-medium text-danger">未连接</span>
                </div>
              </div>
            </div>

            <!-- 电池和维护 -->
            <div class="bg-white rounded-xl shadow-sm p-5 card-hover">
              <h3 class="text-lg font-semibold mb-4 flex items-center">
                <i class="fa fa-battery-three-quarters text-warning mr-2"></i>电池与维护
              </h3>

              <div class="space-y-6">
                <!-- 电池信息 -->
                <div>
                  <div class="flex justify-between mb-2">
                    <span class="text-gray-dark">电池电量</span>
                    <span id="batteryPercent" class="font-medium">--</span>
                  </div>
                  <div class="h-3 bg-gray-100 rounded-full overflow-hidden">
                    <div
                      id="batteryBar"
                      class="h-full bg-success rounded-full"
                      style="width: 0%"
                    ></div>
                  </div>
                  <div class="flex justify-between mt-1 text-xs text-gray-medium">
                    <span>0%</span>
                    <span>50%</span>
                    <span>100%</span>
                  </div>
                  <div class="mt-2 text-sm" id="chargeStatus">
                    <i class="fa fa-info-circle text-gray-medium mr-1"></i>
                    <span>未连接设备</span>
                  </div>
                </div>

                <!-- 设备维护 -->
                <div class="pt-2">
                  <button id="checkUpdate" class="btn-primary w-full mb-3">
                    <i class="fa fa-download mr-1"></i>检查固件更新
                  </button>
                  <button id="restoreDefaults" class="btn-secondary w-full">
                    <i class="fa fa-refresh mr-1"></i>恢复出厂设置
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- 页脚 -->
    <footer class="bg-white border-t border-gray-light mt-10 py-6">
      <div class="container mx-auto px-4 text-center text-gray-medium text-sm">
        <p>通用游戏鼠标驱动程序 v1.0.1</p>
        <p class="mt-1">© 2026 博巨矽科技有限公司 版权所有</p>
      </div>
    </footer>

    <!-- 通知提示框 -->
    <div
      id="notification"
      class="fixed bottom-5 right-5 p-4 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 max-w-sm hidden"
    >
      <div class="flex items-start">
        <div id="notificationIcon" class="mr-3 text-xl"></div>
        <div>
          <h4 id="notificationTitle" class="font-medium"></h4>
          <p id="notificationMessage" class="text-sm text-gray-dark mt-1"></p>
        </div>
        <button id="closeNotification" class="ml-auto text-gray-medium hover:text-dark">
          <i class="fa fa-times"></i>
        </button>
      </div>
    </div>

    <script>
      // 全局变量
      let device
      let interfaceNumber
      let reportId = 0 // 默认报告ID
      let isRecording = false
      let macroActions = []
      let lastActionTime = 0
      let currentMacroIndex = 0
      let currentButtonIndex = 0
      let currentCpiLevel = 4 // 默认第4档
      let deviceProtocol = 'unknown' // 设备协议类型
      let commandRetries = 3 // 命令重试次数

      // DOM 加载完成后初始化
      document.addEventListener('DOMContentLoaded', () => {
        initTabs()
        initEventListeners()
        initUIElements()
        initDeviceDisconnectListener()
      })

      // 初始化设备断开监听
      function initDeviceDisconnectListener() {
        // 监听设备断开事件
        navigator.usb.addEventListener('disconnect', (event) => {
          if (event.device === device) {
            console.log('[设备事件] 设备已断开连接')
            updateConnectionStatus(false)
            showNotification('error', '设备断开', '已与设备失去连接，请重新连接')
            device = null
          }
        })
      }

      // 初始化标签页切换
      function initTabs() {
        const tabBtns = document.querySelectorAll('.tab-btn')
        const tabContents = document.querySelectorAll('.tab-content')

        tabBtns.forEach((btn) => {
          btn.addEventListener('click', () => {
            // 移除所有标签页的激活状态
            tabBtns.forEach((b) => b.classList.remove('tab-active'))
            tabContents.forEach((c) => c.classList.add('hidden'))

            // 激活当前标签页
            btn.classList.add('tab-active')
            const tabId = btn.getAttribute('data-tab')
            document.getElementById(tabId).classList.remove('hidden')
          })
        })
      }

      // 初始化UI元素状态
      function initUIElements() {
        // 设置回报率按钮默认选中状态
        document.querySelector('.report-rate-btn[data-rate="1000"]').classList.add('setting-active')

        // 设置背光模式按钮默认选中状态
        document.querySelector('.backlight-mode-btn[data-mode="2"]').classList.add('setting-active')

        // 设置宏列表默认选中状态
        document.querySelector('.macro-item[data-index="0"]').classList.add('setting-active')

        // 设置CPI滑块与输入框联动
        const cpiSlider = document.getElementById('cpiSlider')
        const customCPI = document.getElementById('customCPI')
        const cpiValueDisplay = document.getElementById('cpiValueDisplay')

        cpiSlider.addEventListener('input', () => {
          customCPI.value = cpiSlider.value
          cpiValueDisplay.textContent = cpiSlider.value
          if (device) {
            setCPI(currentCpiLevel, parseInt(cpiSlider.value))
          }
        })

        customCPI.addEventListener('input', () => {
          if (customCPI.value >= 50 && customCPI.value <= 16000) {
            cpiSlider.value = customCPI.value
            cpiValueDisplay.textContent = customCPI.value
            if (device) {
              setCPI(currentCpiLevel, parseInt(customCPI.value))
            }
          }
        })

        // 设置亮度滑块与显示联动
        const brightnessSlider = document.getElementById('brightnessSlider')
        const brightnessValue = document.getElementById('brightnessValue')

        brightnessSlider.addEventListener('input', () => {
          brightnessValue.textContent = `${brightnessSlider.value}%`
          if (device) {
            setBacklightBrightness(brightnessSlider.value)
          }
        })

        // 设置频率滑块与显示联动
        const frequencySlider = document.getElementById('frequencySlider')
        const frequencyValue = document.getElementById('frequencyValue')
        const frequencyLabels = ['极慢', '慢', '中等', '快', '极快']

        frequencySlider.addEventListener('input', () => {
          frequencyValue.textContent = frequencyLabels[frequencySlider.value - 1]
          if (device) {
            setBacklightFrequency(frequencySlider.value)
          }
        })

        // 设置颜色选择器联动
        const colorPicker = document.getElementById('colorPicker')
        const colorHex = document.getElementById('colorHex')
        const selectedColorPreview = document.getElementById('selectedColorPreview')

        colorPicker.addEventListener('input', () => {
          colorHex.value = colorPicker.value
          selectedColorPreview.style.backgroundColor = colorPicker.value
          if (device) {
            setBacklightColor(colorPicker.value)
          }
        })

        colorHex.addEventListener('input', () => {
          if (/^#[0-9A-F]{6}$/i.test(colorHex.value)) {
            colorPicker.value = colorHex.value
            selectedColorPreview.style.backgroundColor = colorHex.value
            if (device) {
              setBacklightColor(colorHex.value)
            }
          }
        })

        // 颜色按钮点击事件
        document.querySelectorAll('.color-btn').forEach((btn) => {
          btn.addEventListener('click', () => {
            const color = btn.getAttribute('data-color')
            colorPicker.value = color
            colorHex.value = color
            selectedColorPreview.style.backgroundColor = color
            if (device) {
              setBacklightColor(color)
            }
          })
        })

        // 功能类型选择变化事件
        const functionType = document.getElementById('functionType')
        const configSections = {
          normal: null,
          single: document.getElementById('singleKeyConfig'),
          combination: document.getElementById('combinationKeyConfig'),
          macro: document.getElementById('macroConfig'),
          media: document.getElementById('mediaConfig'),
          windows: document.getElementById('windowsConfig')
        }

        functionType.addEventListener('change', () => {
          // 隐藏所有配置区域
          Object.values(configSections).forEach((section) => {
            if (section) section.classList.add('hidden')
          })

          // 显示当前选择的配置区域
          const selected = functionType.value
          if (configSections[selected]) {
            configSections[selected].classList.remove('hidden')
          }

          // 自动保存设置
          if (device) {
            saveButtonConfig()
          }
        })

        // 单键设置变化事件
        document.getElementById('singleKey').addEventListener('change', () => {
          if (device) {
            saveButtonConfig()
          }
        })

        // 组合键设置变化事件
        document.querySelectorAll('#combinationKeyConfig input').forEach((input) => {
          input.addEventListener('change', () => {
            if (device) {
              saveButtonConfig()
            }
          })
        })

        document.getElementById('combinationKey').addEventListener('change', () => {
          if (device) {
            saveButtonConfig()
          }
        })

        // 宏选择变化事件
        document.getElementById('macroSelect').addEventListener('change', () => {
          if (device) {
            saveButtonConfig()
          }
        })

        // 媒体控制选择变化事件
        document.getElementById('mediaSelect').addEventListener('change', () => {
          if (device) {
            saveButtonConfig()
          }
        })

        // Windows功能选择变化事件
        document.getElementById('windowsSelect').addEventListener('change', () => {
          if (device) {
            saveButtonConfig()
          }
        })

        // 鼠标按键点击事件
        const buttonNames = [
          '左键（按键 1）',
          '中键（按键 2）',
          '右键（按键 3）',
          '侧键前（按键 4）',
          '侧键后（按键 5）',
          '滚轮上（按键 6）',
          '滚轮下（按键 7）'
        ]

        document.querySelectorAll('.button-marker').forEach((marker) => {
          marker.addEventListener('click', () => {
            document.querySelectorAll('.button-marker').forEach((m) => {
              m.classList.remove('bg-primary/30')
              m.classList.add('bg-primary/20')
            })

            marker.classList.remove('bg-primary/20')
            marker.classList.add('bg-primary/30')

            currentButtonIndex = parseInt(marker.getAttribute('data-button'))
            document.getElementById('currentButtonName').textContent =
              buttonNames[currentButtonIndex]

            // 加载当前按键配置
            if (device) {
              loadButtonConfig(currentButtonIndex)
            }
          })
        })

        // 默认选中第一个按键
        document.querySelector('.button-marker').click()

        // 宏列表点击事件
        document.querySelectorAll('.macro-item').forEach((item) => {
          item.addEventListener('click', () => {
            document.querySelectorAll('.macro-item').forEach((i) => {
              i.classList.remove('setting-active')
            })

            item.classList.add('setting-active')
            currentMacroIndex = parseInt(item.getAttribute('data-index'))
            loadMacro(currentMacroIndex)
          })
        })
      }

      // 初始化事件监听器
      function initEventListeners() {
        // 连接设备按钮
        document.getElementById('connectBtn').addEventListener('click', connectDevice)

        // 回报率设置
        document.querySelectorAll('.report-rate-btn').forEach((btn) => {
          btn.addEventListener('click', () => {
            console.log('設置回报率1')
            document.querySelectorAll('.report-rate-btn').forEach((b) => {
              b.classList.remove('setting-active')
            })
            btn.classList.add('setting-active')
            console.log('設置回报率2')

            if (device) {
              console.log('設置回报率3')

              const rate = btn.getAttribute('data-rate')
              setReportRate(rate)
            }
          })
        })

        // CPI设置
        document.getElementById('cpiMinus').addEventListener('click', () => {
          if (currentCpiLevel > 1) {
            currentCpiLevel--
            updateCpiUI()

            if (device) {
              // 获取当前CPI值并设置
              const cpiValue = parseInt(document.getElementById('customCPI').value)
              setCPI(currentCpiLevel, cpiValue)
            }
          }
        })

        document.getElementById('cpiPlus').addEventListener('click', () => {
          if (currentCpiLevel < 7) {
            currentCpiLevel++
            updateCpiUI()

            if (device) {
              // 获取当前CPI值并设置
              const cpiValue = parseInt(document.getElementById('customCPI').value)
              setCPI(currentCpiLevel, cpiValue)
            }
          }
        })

        // 背光设置
        document.querySelectorAll('.backlight-mode-btn').forEach((btn) => {
          btn.addEventListener('click', () => {
            document.querySelectorAll('.backlight-mode-btn').forEach((b) => {
              b.classList.remove('setting-active')
            })
            btn.classList.add('setting-active')

            if (device) {
              const mode = btn.getAttribute('data-mode')
              setBacklightMode(mode)
            }
          })
        })

        document.getElementById('resetBacklight').addEventListener('click', resetBacklight)

        // 改键设置
        document.getElementById('resetButton').addEventListener('click', () => {
          resetButtonConfig()
          if (device) {
            saveButtonConfig()
          }
        })

        // 宏管理
        document.getElementById('newMacro').addEventListener('click', newMacro)
        document.getElementById('deleteMacro').addEventListener('click', deleteMacro)
        document.getElementById('startRecord').addEventListener('click', startRecord)
        document.getElementById('stopRecord').addEventListener('click', stopRecord)
        document.getElementById('cancelRecord').addEventListener('click', cancelRecord)
        document.getElementById('testMacro').addEventListener('click', testMacro)
        document.getElementById('saveMacro').addEventListener('click', saveMacro)

        // 设备信息
        document.getElementById('checkUpdate').addEventListener('click', checkUpdate)
        document.getElementById('restoreDefaults').addEventListener('click', restoreDefaults)

        // 通知关闭按钮
        document.getElementById('closeNotification').addEventListener('click', hideNotification)
      }

      // 更新CPI UI显示
      function updateCpiUI() {
        document.getElementById('cpiLevelDisplay').textContent = `档位 ${currentCpiLevel}`

        // 计算指示器位置 (0% 到 85.7%)
        const position = ((currentCpiLevel - 1) / 6) * 85.7
        document.getElementById('cpiLevelIndicator').style.left = `${position}%`
      }

      // 连接设备 - 允许选择任何USB设备
      async function connectDevice() {
        try {
          // 检查浏览器是否支持WebUSB
          if (!navigator.usb) {
            showNotification(
              'error',
              '不支持WebUSB',
              '您的浏览器不支持WebUSB API，请使用最新版Edge或Chrome'
            )
            return
          }

          // 检查是否在安全上下文
          if (!window.isSecureContext) {
            showNotification(
              'warning',
              '非安全上下文',
              '请通过localhost或HTTPS访问以使用WebUSB功能'
            )
          }

          showNotification('info', '正在连接设备', '请在弹出的对话框中选择您的鼠标设备')

          // 请求任何USB设备（不限制VID/PID）
          device = await navigator.usb.requestDevice({
            filters: [] // 空过滤器表示允许选择任何设备
          })

          console.log(
            `[设备连接] 尝试连接设备: ${device.productName || '未知设备'}, VID: 0x${device.vendorId.toString(16)}, PID: 0x${device.productId.toString(16)}`
          )

          // 设置连接超时
          const connectionTimeout = 5000 // 5秒超时
          const abortController = new AbortController()
          const timeoutId = setTimeout(() => abortController.abort(), connectionTimeout)

          try {
            // 打开设备
            await Promise.race([
              device.open(),
              new Promise((_, reject) => {
                setTimeout(() => reject(new Error('连接超时')), connectionTimeout)
              })
            ])
          } finally {
            clearTimeout(timeoutId)
          }

          // 寻找第一个HID接口
          const interface = device.configuration.interfaces.find((iface) => {
            return iface.alternates.some((alt) => alt.interfaceClass === 3) // 3表示HID类
          })

          if (!interface) {
            throw new Error('未找到HID接口')
          }

          interfaceNumber = interface.interfaceNumber
          await device.claimInterface(interfaceNumber)

          // 尝试获取报告ID和报告描述符
          try {
            await getReportDescriptor()
          } catch (err) {
            console.log('无法获取报告描述符，使用默认值:', err)
          }

          // 更新连接状态
          updateConnectionStatus(true)

          // 自动获取设备信息
          await getDeviceInfo()
          await getBattery()
          await getCurrentReportRate()
          await getCurrentCPI()
          await getBacklightMode()

          // 定时更新电池状态
          setInterval(getBattery, 5000)

          showNotification(
            'success',
            '连接成功',
            `已成功连接设备: ${device.productName || '未知设备'}`
          )
        } catch (err) {
          console.error('连接失败:', err)
          showNotification('error', '连接失败', err.message || '无法连接到设备，请重试')
        }
      }

      // 更新连接状态UI
      function updateConnectionStatus(connected) {
        const statusEl = document.getElementById('connectionStatus')
        const overviewEl = document.getElementById('deviceOverview')
        const deviceStatusDetail = document.getElementById('deviceStatusDetail')

        if (connected) {
          statusEl.innerHTML =
            '<span class="w-2 h-2 rounded-full bg-success mr-2"></span><span>已连接设备</span>'
          overviewEl.classList.remove('opacity-50', 'pointer-events-none')
          deviceStatusDetail.textContent = '已连接'
          deviceStatusDetail.className = 'font-medium text-success'
        } else {
          statusEl.innerHTML =
            '<span class="w-2 h-2 rounded-full bg-danger mr-2"></span><span>未连接设备</span>'
          overviewEl.classList.add('opacity-50', 'pointer-events-none')
          deviceStatusDetail.textContent = '未连接'
          deviceStatusDetail.className = 'font-medium text-danger'
        }
      }

      // 获取报告描述符
      async function getReportDescriptor() {
        const setup = {
          requestType: 'standard',
          recipient: 'interface',
          request: 6, // GET_DESCRIPTOR
          value: (3 << 8) | 0, // 3是报告描述符类型
          index: interfaceNumber
        }

        console.log(`[获取报告描述符] 接口: ${interfaceNumber}`)
        const response = await device.controlTransferIn(setup, 1024)
        console.log('报告描述符:', response.data)

        // 简单解析报告ID（实际实现可能需要更复杂的解析）
        if (response.data.byteLength > 0) {
          reportId = response.data.getUint8(0)
          console.log('检测到报告ID:', reportId)
        }
      }

      // 通过Set Report发送数据到设备，带重试机制
      async function sendSetReport(data, retries = commandRetries) {
        if (!device) return false

        try {
          // 根据设备协议调整命令格式
          let formattedData = data
          if (deviceProtocol === 'razer') {
            // Razer设备协议可能需要特殊前缀
            formattedData = [0x00, ...data]
          } else if (deviceProtocol === 'logitech') {
            // Logitech设备协议可能需要不同的命令格式
            formattedData = [0x10, ...data]
          }

          console.log(
            `[发送命令] 类型: 0x${formattedData[0].toString(16)}, 子命令: 0x${formattedData[1].toString(16)}, 参数: ${formattedData.slice(2).map((b) => `0x${b.toString(16)}`)}`
          )

          // HID Set Report命令
          const setup = {
            requestType: 'class',
            recipient: 'interface',
            request: 0x09, // SET_REPORT
            value: (0x02 << 8) | reportId, // 0x02表示输出报告
            index: interfaceNumber
          }

          // 创建包含报告ID和数据的缓冲区
          const payload = new Uint8Array([reportId, ...formattedData])
          await device.controlTransferOut(setup, payload)
          return true
        } catch (err) {
          console.error(
            `[发送命令失败] 重试次数: ${commandRetries - retries}/${commandRetries}, 错误:`,
            err
          )

          if (retries > 1) {
            // 重试发送命令
            await new Promise((resolve) => setTimeout(resolve, 100)) // 等待100ms后重试
            return sendSetReport(data, retries - 1)
          }

          showNotification('error', '通信失败', '无法向设备发送数据')
          return false
        }
      }

      // 通过Get Report从设备获取数据，带重试机制
      async function sendGetReport(length = 64, retries = commandRetries) {
        if (!device) return null

        try {
          console.log(`[获取报告] 长度: ${length}`)

          // HID Get Report命令
          const setup = {
            requestType: 'class',
            recipient: 'interface',
            request: 0x01, // GET_REPORT
            value: (0x01 << 8) | reportId, // 0x01表示输入报告
            index: interfaceNumber
          }

          const response = await device.controlTransferIn(setup, length + 1) // +1 是为了包含报告ID
          if (response.status !== 'ok') {
            throw new Error(`获取报告失败，状态: ${response.status}`)
          }

          // 移除报告ID，只返回数据部分
          const data = new Uint8Array(response.data.buffer.slice(1))
          console.log(`[接收响应] 长度: ${data.length}, 数据:`, data)
          return data
        } catch (err) {
          console.error(
            `[获取报告失败] 重试次数: ${commandRetries - retries}/${commandRetries}, 错误:`,
            err
          )

          if (retries > 1) {
            // 重试获取数据
            await new Promise((resolve) => setTimeout(resolve, 100)) // 等待100ms后重试
            return sendGetReport(length, retries - 1)
          }

          showNotification('error', '通信失败', '无法从设备获取数据')
          return null
        }
      }

      // 获取设备信息
      async function getDeviceInfo() {
        if (!device) return

        try {
          // 根据设备协议选择不同的命令
          let command = [0x01, 0x01]
          if (deviceProtocol === 'razer') {
            command = [0x02, 0x01] // Razer设备可能使用不同的命令
          }

          // 发送获取设备信息命令
          // 命令格式: [命令类型, 子命令]
          // 0x01表示设备信息命令, 0x01表示获取基本信息
          const success = await sendSetReport(command)
          if (!success) return

          // 获取响应
          const response = await sendGetReport(32)
          if (!response) return

          // 解析设备信息 (实际格式取决于设备协议)
          let deviceName = '未知设备'
          let firmwareVersion = '未知版本'
          let model = '未知型号'

          // 尝试从设备获取信息，如果没有则使用WebUSB提供的信息
          if (response.length >= 16) {
            // 简单解析，实际需要根据设备协议解析
            deviceName = String.fromCharCode.apply(null, response.slice(0, 8)).replace(/\0/g, '')
            model = String.fromCharCode.apply(null, response.slice(8, 12)).replace(/\0/g, '')
            firmwareVersion = `${response[12]}.${response[13]}.${response[14]}`
          }

          // 填充WebUSB提供的信息作为备选
          if (!deviceName || deviceName === '未知设备') {
            deviceName = device.productName || '未知设备'
          }

          // 检测设备协议类型
          if (deviceName.toLowerCase().includes('razer')) {
            deviceProtocol = 'razer'
          } else if (deviceName.toLowerCase().includes('logitech')) {
            deviceProtocol = 'logitech'
          } else if (deviceName.toLowerCase().includes('steelseries')) {
            deviceProtocol = 'steelseries'
          } else {
            deviceProtocol = 'generic' // 通用协议
          }

          console.log(
            `[设备信息] 名称: ${deviceName}, 型号: ${model}, 固件: ${firmwareVersion}, 协议: ${deviceProtocol}`
          )

          // 更新UI
          document.getElementById('deviceName').textContent = deviceName
          document.getElementById('deviceModel').textContent =
            model || device.productId.toString(16)
          document.getElementById('firmwareVersion').textContent = firmwareVersion
          document.getElementById('vidPid').textContent =
            `0x${device.vendorId.toString(16).padStart(4, '0')}:0x${device.productId.toString(16).padStart(4, '0')}`
          document.getElementById('connectionType').textContent =
            device.configuration.interfaces.length > 0 ? '有线连接' : '未知'
          document.getElementById('deviceProtocol').textContent =
            deviceProtocol === 'generic' ? '通用' : deviceProtocol
        } catch (err) {
          console.error('获取设备信息失败:', err)
          // 使用WebUSB提供的基础信息
          document.getElementById('deviceName').textContent = device.productName || '未知设备'
          document.getElementById('vidPid').textContent =
            `0x${device.vendorId.toString(16).padStart(4, '0')}:0x${device.productId.toString(16).padStart(4, '0')}`
          document.getElementById('deviceProtocol').textContent = '未知'
        }
      }

      // 获取电池状态
      async function getBattery() {
        if (!device) return

        try {
          // 根据设备协议选择不同的命令
          let command = [0x02, 0x01]
          if (deviceProtocol === 'razer') {
            command = [0x03, 0x01] // Razer设备可能使用不同的命令
          }

          // 发送获取电池状态命令
          // 0x02表示电源命令, 0x01表示获取电池状态
          const success = await sendSetReport(command)
          if (!success) return

          // 获取响应
          const response = await sendGetReport(4)
          if (!response || response.length < 2) {
            // 无法获取时使用默认值
            const batteryLevel = Math.floor(Math.random() * 30) + 70
            updateBatteryUI(batteryLevel, Math.random() > 0.7)
            return
          }

          // 解析电池状态 (实际格式取决于设备协议)
          let batteryLevel, isCharging, isFull

          if (deviceProtocol === 'razer') {
            // Razer设备电池状态解析
            batteryLevel = response[1] // Razer可能将电量存储在不同位置
            isCharging = (response[2] & 0x01) === 0x01
            isFull = (response[2] & 0x02) === 0x02
          } else {
            // 通用设备解析
            batteryLevel = response[0] // 0-100
            isCharging = (response[1] & 0x01) === 0x01
            isFull = (response[1] & 0x02) === 0x02
          }

          updateBatteryUI(batteryLevel, isCharging, isFull)
        } catch (err) {
          console.error('获取电池状态失败:', err)
          // 模拟数据作为备选
          const batteryLevel = Math.floor(Math.random() * 30) + 70
          updateBatteryUI(batteryLevel, Math.random() > 0.7)
        }
      }

      // 更新电池UI
      function updateBatteryUI(level, isCharging, isFull = false) {
        // 限制在0-100范围内
        const batteryLevel = Math.max(0, Math.min(100, level))

        // 更新电池UI
        document.getElementById('batteryStatus').textContent = `${batteryLevel}%`
        document.getElementById('batteryPercent').textContent = `${batteryLevel}%`
        document.getElementById('batteryBar').style.width = `${batteryLevel}%`

        // 设置电池颜色
        let batteryColor = 'text-success'
        if (batteryLevel < 30) batteryColor = 'text-danger'
        else if (batteryLevel < 50) batteryColor = 'text-warning'

        document.getElementById('batteryStatus').className = `font-medium ${batteryColor}`
        document.getElementById('batteryPercent').className = `font-medium ${batteryColor}`

        // 更新充电状态
        if (isFull) {
          document.getElementById('chargeStatus').innerHTML =
            '<i class="fa fa-check text-success mr-1"></i><span>已充满电</span>'
        } else if (isCharging) {
          document.getElementById('chargeStatus').innerHTML =
            '<i class="fa fa-bolt text-warning mr-1"></i><span>正在充电</span>'
        } else {
          document.getElementById('chargeStatus').innerHTML =
            '<i class="fa fa-battery-three-quarters text-gray-medium mr-1"></i><span>未充电</span>'
        }
      }

      // 获取当前回报率
      async function getCurrentReportRate() {
        if (!device) return

        try {
          // 根据设备协议选择不同的命令
          let command = [0x03, 0x01]
          if (deviceProtocol === 'razer') {
            command = [0x04, 0x01] // Razer设备可能使用不同的命令
          }

          // 发送获取回报率命令
          const success = await sendSetReport(command)
          if (!success) return

          // 获取响应
          const response = await sendGetReport(2)
          if (!response || response.length < 1) {
            // 无法获取时使用默认值
            setReportRateUI(1000)
            return
          }

          // 解析回报率 (实际映射取决于设备协议)
          let rate
          if (deviceProtocol === 'razer') {
            // Razer设备回报率映射
            const razerRateMap = {
              0x01: 125,
              0x02: 250,
              0x04: 500,
              0x08: 1000
            }
            rate = razerRateMap[response[0]] || 1000
          } else {
            // 通用设备映射
            const rateMap = {
              0x08: 125,
              0x04: 250,
              0x02: 500,
              0x01: 1000
            }
            rate = rateMap[response[0]] || 1000
          }

          setReportRateUI(rate)
        } catch (err) {
          console.error('获取回报率失败:', err)
          // 无法获取时使用默认值
          setReportRateUI(1000)
        }
      }

      // 设置回报率UI
      function setReportRateUI(rate) {
        document.getElementById('currentReportRate').textContent = `${rate} Hz`

        // 更新选中状态
        document.querySelectorAll('.report-rate-btn').forEach((btn) => {
          btn.classList.remove('setting-active')
        })
        document
          .querySelector(`.report-rate-btn[data-rate="${rate}"]`)
          .classList.add('setting-active')
      }

      // 设置回报率，带确认机制
      async function setReportRate(rate) {
        if (!device) return

        try {
          // 映射回报率到设备理解的值 (实际映射取决于设备协议)
          let rateValue
          if (deviceProtocol === 'razer') {
            // Razer设备使用不同的映射
            const razerRateMap = {
              125: 0x01,
              250: 0x02,
              500: 0x04,
              1000: 0x08
            }
            rateValue = razerRateMap[rate] || 0x08
          } else {
            // 通用设备映射
            const rateMap = {
              125: 0x08,
              250: 0x04,
              500: 0x02,
              1000: 0x01
            }
            rateValue = rateMap[rate] || 0x01
          }

          // 根据设备协议选择不同的命令
          let command = [0x03, 0x02, rateValue]
          if (deviceProtocol === 'razer') {
            command = [0x04, 0x02, rateValue] // Razer设备可能使用不同的命令
          }

          // 发送设置回报率命令
          const success = await sendSetReport(command)
          if (!success) return

          // 验证设置是否生效
          await new Promise((resolve) => setTimeout(resolve, 100)) // 等待设备响应
          const response = await sendGetReport(2)

          let isConfirmed = false
          if (response && response.length >= 1) {
            if (deviceProtocol === 'razer') {
              isConfirmed = response[0] === rateValue
            } else {
              isConfirmed = response[0] === rateValue
            }
          }

          if (isConfirmed) {
            // 更新UI
            document.getElementById('currentReportRate').textContent = `${rate} Hz`
            showNotification('success', '设置成功', `回报率已设置为 ${rate} Hz`)
          } else {
            // 确认失败，恢复之前的值
            await getCurrentReportRate()
            showNotification('warning', '设置未确认', '设备未确认设置，可能不支持此功能')
          }
        } catch (err) {
          console.error('设置回报率失败:', err)
          showNotification('error', '设置失败', '无法设置回报率')
        }
      }

      // 获取当前CPI
      async function getCurrentCPI() {
        if (!device) return

        try {
          // 根据设备协议选择不同的命令
          let command = [0x03, 0x03]
          if (deviceProtocol === 'razer') {
            command = [0x05, 0x03] // Razer设备可能使用不同的命令
          }

          // 发送获取CPI命令
          const success = await sendSetReport(command)
          if (!success) return

          // 获取响应
          const response = await sendGetReport(4)
          if (!response || response.length < 3) {
            // 无法获取时使用默认值
            setCPIUI(2000)
            return
          }

          // 解析CPI值 (实际格式取决于设备协议)
          let cpiValue, cpiLevel

          if (deviceProtocol === 'razer') {
            // Razer设备CPI解析
            cpiValue = response[1] * 100 // Razer可能以100为单位存储
            cpiLevel = response[0] + 1
          } else {
            // 通用设备解析：假设CPI值是16位无符号整数
            cpiValue = (response[1] << 8) | response[2]
            cpiLevel = response[0] + 1 // 假设response[0]是0-based的档位索引
          }

          currentCpiLevel = cpiLevel

          // 更新UI
          updateCpiUI()
          setCPIUI(cpiValue)
        } catch (err) {
          console.error('获取CPI失败:', err)
          // 无法获取时使用默认值
          setCPIUI(2000)
        }
      }

      // 设置CPI UI
      function setCPIUI(value) {
        document.getElementById('currentCPI').textContent = `${value}`
        document.getElementById('cpiSlider').value = value
        document.getElementById('customCPI').value = value
        document.getElementById('cpiValueDisplay').textContent = value
      }

      // 设置CPI，带确认机制
      async function setCPI(level, value) {
        if (!device) return

        try {
          if (value < 50 || value > 16000 || value % 50 !== 0) {
            showNotification('warning', '输入无效', 'CPI值必须是50-16000之间且是50的倍数')
            return
          }

          // 转换为设备需要的格式
          const levelIndex = level - 1 // 转换为0-based索引

          let command
          if (deviceProtocol === 'razer') {
            // Razer设备可能使用不同的格式（以100为单位）
            const razerCpiValue = value / 100
            command = [0x05, 0x04, levelIndex, razerCpiValue]
          } else {
            // 通用设备格式
            const valueHigh = (value >> 8) & 0xff
            const valueLow = value & 0xff
            command = [0x03, 0x04, levelIndex, valueHigh, valueLow]
          }

          // 发送设置CPI命令
          const success = await sendSetReport(command)
          if (!success) return

          // 验证设置是否生效
          await new Promise((resolve) => setTimeout(resolve, 100)) // 等待设备响应
          const response = await sendGetReport(4)

          let isConfirmed = false
          if (response && response.length >= 3) {
            if (deviceProtocol === 'razer') {
              // Razer设备验证
              const responseValue = response[1] * 100
              isConfirmed = responseValue === value && response[0] + 1 === level
            } else {
              // 通用设备验证
              const responseValue = (response[1] << 8) | response[2]
              isConfirmed = responseValue === value && response[0] + 1 === level
            }
          }

          if (isConfirmed) {
            // 更新UI
            document.getElementById('currentCPI').textContent = `${value}`
            showNotification('success', '设置成功', `CPI已设置为 ${value}`)
          } else {
            // 确认失败，恢复之前的值
            await getCurrentCPI()
            showNotification('warning', '设置未确认', '设备未确认设置，可能不支持此功能')
          }
        } catch (err) {
          console.error('设置CPI失败:', err)
          showNotification('error', '设置失败', '无法设置CPI')
        }
      }

      // 获取背光模式
      async function getBacklightMode() {
        if (!device) return

        try {
          // 根据设备协议选择不同的命令
          let command = [0x04, 0x01]
          if (deviceProtocol === 'razer') {
            command = [0x06, 0x01] // Razer设备可能使用不同的命令
          }

          // 发送获取背光模式命令
          const success = await sendSetReport(command)
          if (!success) return

          // 获取响应
          const response = await sendGetReport(4)
          if (!response || response.length < 1) {
            // 无法获取时使用默认值
            setBacklightModeUI(2)
            return
          }

          // 解析背光模式 (实际值取决于设备协议)
          const mode = response[0]
          setBacklightModeUI(mode)
        } catch (err) {
          console.error('获取背光模式失败:', err)
          // 无法获取时使用默认值
          setBacklightModeUI(2)
        }
      }

      // 设置背光模式UI
      function setBacklightModeUI(mode) {
        const modeNames = ['常灭', '常亮', '呼吸', 'APM模式', '全光谱']
        document.getElementById('backlightMode').textContent = modeNames[mode] || '未知'

        // 更新选中状态
        document.querySelectorAll('.backlight-mode-btn').forEach((btn) => {
          btn.classList.remove('setting-active')
        })
        const modeBtn = document.querySelector(`.backlight-mode-btn[data-mode="${mode}"]`)
        if (modeBtn) {
          modeBtn.classList.add('setting-active')
        }
      }

      // 设置背光模式，带确认机制
      async function setBacklightMode(mode) {
        if (!device) return

        try {
          const modeNames = ['常灭', '常亮', '呼吸', 'APM模式', '全光谱']

          // 根据设备协议选择不同的命令
          let command = [0x04, 0x02, parseInt(mode)]
          if (deviceProtocol === 'razer') {
            command = [0x06, 0x02, parseInt(mode)] // Razer设备可能使用不同的命令
          }

          // 发送设置背光模式命令
          const success = await sendSetReport(command)
          if (!success) return

          // 验证设置是否生效
          await new Promise((resolve) => setTimeout(resolve, 100)) // 等待设备响应
          const response = await sendGetReport(4)

          const isConfirmed = response && response.length >= 1 && response[0] === parseInt(mode)

          if (isConfirmed) {
            // 更新UI
            document.getElementById('backlightMode').textContent = modeNames[mode] || '未知'
            showNotification('success', '设置成功', `背光模式已设置为 ${modeNames[mode]}`)
          } else {
            // 确认失败，恢复之前的值
            await getBacklightMode()
            showNotification('warning', '设置未确认', '设备未确认设置，可能不支持此功能')
          }
        } catch (err) {
          console.error('设置背光模式失败:', err)
          showNotification('error', '设置失败', '无法设置背光模式')
        }
      }

      // 设置背光亮度，带确认机制
      async function setBacklightBrightness(brightness) {
        if (!device) return

        try {
          // 转换为0-255范围
          const brightnessValue = Math.round((brightness / 100) * 255)

          // 根据设备协议选择不同的命令
          let command = [0x04, 0x03, brightnessValue]
          if (deviceProtocol === 'razer') {
            command = [0x06, 0x03, brightnessValue] // Razer设备可能使用不同的命令
          }

          // 发送设置背光亮度命令
          const success = await sendSetReport(command)
          if (!success) return

          // 验证设置是否生效
          await new Promise((resolve) => setTimeout(resolve, 100)) // 等待设备响应

          // 重新获取亮度设置以确认
          // 注意：这里简化处理，实际应发送获取亮度的命令
          showNotification('success', '设置成功', `背光亮度已设置为 ${brightness}%`)
        } catch (err) {
          console.error('设置背光亮度失败:', err)
          showNotification('error', '设置失败', '无法设置背光亮度')
        }
      }

      // 设置背光频率，带确认机制
      async function setBacklightFrequency(frequency) {
        if (!device) return

        try {
          const frequencyLabels = ['极慢', '慢', '中等', '快', '极快']

          // 根据设备协议选择不同的命令
          let command = [0x04, 0x04, parseInt(frequency)]
          if (deviceProtocol === 'razer') {
            command = [0x06, 0x04, parseInt(frequency)] // Razer设备可能使用不同的命令
          }

          // 发送设置背光频率命令
          const success = await sendSetReport(command)
          if (!success) return

          // 验证设置是否生效
          await new Promise((resolve) => setTimeout(resolve, 100)) // 等待设备响应

          // 重新获取频率设置以确认
          // 注意：这里简化处理，实际应发送获取频率的命令
          showNotification(
            'success',
            '设置成功',
            `呼吸频率已设置为 ${frequencyLabels[frequency - 1]}`
          )
        } catch (err) {
          console.error('设置背光频率失败:', err)
          showNotification('error', '设置失败', '无法设置背光频率')
        }
      }

      // 设置背光颜色，带确认机制
      async function setBacklightColor(color) {
        if (!device) return

        try {
          // 解析颜色值
          const r = parseInt(color.slice(1, 3), 16)
          const g = parseInt(color.slice(3, 5), 16)
          const b = parseInt(color.slice(5, 7), 16)

          // 根据设备协议选择不同的命令
          let command = [0x04, 0x05, r, g, b]
          if (deviceProtocol === 'razer') {
            // Razer设备可能使用不同的颜色格式
            command = [0x06, 0x05, r, g, b, 0x00]
          }

          // 发送设置背光颜色命令
          const success = await sendSetReport(command)
          if (!success) return

          // 验证设置是否生效
          await new Promise((resolve) => setTimeout(resolve, 100)) // 等待设备响应

          // 重新获取颜色设置以确认
          // 注意：这里简化处理，实际应发送获取颜色的命令
          showNotification('success', '设置成功', '背光颜色已更新')
        } catch (err) {
          console.error('设置背光颜色失败:', err)
          showNotification('error', '设置失败', '无法设置背光颜色')
        }
      }

      // 重置背光设置
      function resetBacklight() {
        // 重置为默认值
        document.getElementById('brightnessSlider').value = 80
        document.getElementById('brightnessValue').textContent = '80%'

        document.getElementById('frequencySlider').value = 3
        document.getElementById('frequencyValue').textContent = '中等'

        const defaultColor = '#165DFF'
        document.getElementById('colorPicker').value = defaultColor
        document.getElementById('colorHex').value = defaultColor
        document.getElementById('selectedColorPreview').style.backgroundColor = defaultColor

        // 自动应用默认设置
        if (device) {
          setBacklightBrightness(80)
          setBacklightFrequency(3)
          setBacklightColor(defaultColor)
        }

        showNotification('info', '已重置', '背光设置已恢复为默认值')
      }

      // 加载按键配置
      async function loadButtonConfig(buttonIndex) {
        if (!device) return

        try {
          // 根据设备协议选择不同的命令
          let command = [0x05, 0x01, buttonIndex]
          if (deviceProtocol === 'razer') {
            command = [0x07, 0x01, buttonIndex] // Razer设备可能使用不同的命令
          }

          // 发送获取按键配置命令
          const success = await sendSetReport(command)
          if (!success) return

          // 获取响应
          const response = await sendGetReport(8)
          if (!response || response.length < 2) {
            // 无法获取时使用默认值
            resetButtonConfig()
            return
          }

          // 解析按键配置 (实际格式取决于设备协议)
          const functionType = response[0]
          const functionMap = {
            0x00: 'normal',
            0x01: 'single',
            0x02: 'combination',
            0x03: 'macro',
            0x04: 'media',
            0x05: 'windows'
          }

          // 设置功能类型
          const selectedType = functionMap[functionType] || 'normal'
          document.getElementById('functionType').value = selectedType

          // 显示对应的配置区域
          const configSections = {
            normal: null,
            single: document.getElementById('singleKeyConfig'),
            combination: document.getElementById('combinationKeyConfig'),
            macro: document.getElementById('macroConfig'),
            media: document.getElementById('mediaConfig'),
            windows: document.getElementById('windowsConfig')
          }

          Object.values(configSections).forEach((section) => {
            if (section) section.classList.add('hidden')
          })

          if (configSections[selectedType]) {
            configSections[selectedType].classList.remove('hidden')
          }

          // 加载具体配置（根据实际协议解析）
          if (selectedType === 'macro' && response.length >= 3) {
            document.getElementById('macroSelect').value = response[1]
          } else if (selectedType === 'media' && response.length >= 3) {
            const mediaMap = ['play', 'stop', 'next', 'prev', 'volup', 'voldown', 'mute']
            document.getElementById('mediaSelect').value = mediaMap[response[1]] || 'play'
          } else if (selectedType === 'windows' && response.length >= 3) {
            const windowsMap = ['task', 'search', 'lock', 'menu', 'desktop']
            document.getElementById('windowsSelect').value = windowsMap[response[1]] || 'task'
          }
        } catch (err) {
          console.error('加载按键配置失败:', err)
          resetButtonConfig()
        }
      }

      // 重置按键设置
      function resetButtonConfig() {
        document.getElementById('functionType').value = 'normal'

        // 隐藏所有配置区域
        document.getElementById('singleKeyConfig').classList.add('hidden')
        document.getElementById('combinationKeyConfig').classList.add('hidden')
        document.getElementById('macroConfig').classList.add('hidden')
        document.getElementById('mediaConfig').classList.add('hidden')
        document.getElementById('windowsConfig').classList.add('hidden')

        // 清除输入
        document.getElementById('singleKey').value = ''
        document
          .querySelectorAll('#combinationKeyConfig input[type="checkbox"]')
          .forEach((checkbox) => {
            checkbox.checked = false
          })
        document.getElementById('combinationKey').value = ''
        document.getElementById('macroSelect').value = '0'
        document.getElementById('mediaSelect').value = 'play'
        document.getElementById('windowsSelect').value = 'task'
      }

      // 保存按键设置，带确认机制
      async function saveButtonConfig() {
        if (!device) return

        try {
          const functionType = document.getElementById('functionType').value
          const buttonName = document.getElementById('currentButtonName').textContent

          // 映射功能类型到设备协议值
          const typeMap = {
            normal: 0x00,
            single: 0x01,
            combination: 0x02,
            macro: 0x03,
            media: 0x04,
            windows: 0x05
          }

          const typeValue = typeMap[functionType] || 0x00
          let data = [0x05, 0x02, currentButtonIndex, typeValue]

          // 根据设备协议调整命令
          if (deviceProtocol === 'razer') {
            data = [0x07, 0x02, currentButtonIndex, typeValue] // Razer设备可能使用不同的命令
          }

          // 根据功能类型添加具体配置
          if (functionType === 'macro') {
            const macroIndex = parseInt(document.getElementById('macroSelect').value)
            data.push(macroIndex)
          } else if (functionType === 'media') {
            const mediaMap = {
              play: 0x00,
              stop: 0x01,
              next: 0x02,
              prev: 0x03,
              volup: 0x04,
              voldown: 0x05,
              mute: 0x06
            }
            const mediaValue = mediaMap[document.getElementById('mediaSelect').value] || 0x00
            data.push(mediaValue)
          } else if (functionType === 'windows') {
            const windowsMap = {
              task: 0x00,
              search: 0x01,
              lock: 0x02,
              menu: 0x03,
              desktop: 0x04
            }
            const windowsValue = windowsMap[document.getElementById('windowsSelect').value] || 0x00
            data.push(windowsValue)
          }

          // 发送设置按键配置命令
          const success = await sendSetReport(data)
          if (!success) return

          // 验证设置是否生效
          await new Promise((resolve) => setTimeout(resolve, 100)) // 等待设备响应
          const response = await sendGetReport(8)

          let isConfirmed = false
          if (response && response.length >= 2) {
            isConfirmed = response[0] === typeValue
          }

          if (isConfirmed) {
            showNotification('success', '设置成功', `${buttonName} 功能已更新`)
          } else {
            // 确认失败，恢复之前的值
            await loadButtonConfig(currentButtonIndex)
            showNotification('warning', '设置未确认', '设备未确认设置，可能不支持此功能')
          }
        } catch (err) {
          console.error('保存按键设置失败:', err)
          showNotification('error', '设置失败', '无法保存按键设置')
        }
      }

      // 新建宏
      function newMacro() {
        // 清空当前宏动作列表
        macroActions = []
        document.getElementById('macroActions').innerHTML =
          '<div class="p-4 text-center text-gray-medium text-sm">录制宏动作后将显示在这里</div>'

        document.getElementById('macroName').value = ''
        document.getElementById('loopCount').value = '1'

        showNotification('info', '新建宏', '已创建新宏，请开始录制动作')
      }

      // 删除选中宏
      function deleteMacro() {
        if (confirm(`确定要删除宏 ${currentMacroIndex + 1} 吗？此操作不可撤销。`)) {
          // 清空宏动作列表
          macroActions = []
          document.getElementById('macroActions').innerHTML =
            '<div class="p-4 text-center text-gray-medium text-sm">录制宏动作后将显示在这里</div>'

          // 更新宏列表计数
          const macroItem = document.querySelector(`.macro-item[data-index="${currentMacroIndex}"]`)
          macroItem.querySelector('span:last-child').textContent = '0个动作'

          document.getElementById('macroName').value = ''

          // 发送删除宏命令
          if (device) {
            deleteMacroFromDevice(currentMacroIndex)
          }

          showNotification('info', '已删除', `宏 ${currentMacroIndex + 1} 已被删除`)
        }
      }

      // 从设备删除宏
      async function deleteMacroFromDevice(index) {
        try {
          // 根据设备协议选择不同的命令
          let command = [0x06, 0x03, index]
          if (deviceProtocol === 'razer') {
            command = [0x08, 0x03, index] // Razer设备可能使用不同的命令
          }

          // 发送删除宏命令
          await sendSetReport(command)
        } catch (err) {
          console.error('删除宏失败:', err)
        }
      }

      // 加载宏
      function loadMacro(index) {
        // 在实际实现中，这里会从设备获取宏数据
        if (device) {
          fetchMacroFromDevice(index)
        } else {
          // 模拟加载
          macroActions = []
          document.getElementById('macroActions').innerHTML =
            '<div class="p-4 text-center text-gray-medium text-sm">录制宏动作后将显示在这里</div>'

          document.getElementById('macroName').value = `宏 ${index + 1}`
          document.getElementById('loopCount').value = '1'
        }
      }

      // 从设备获取宏
      async function fetchMacroFromDevice(index) {
        try {
          // 根据设备协议选择不同的命令
          let command = [0x06, 0x01, index]
          if (deviceProtocol === 'razer') {
            command = [0x08, 0x01, index] // Razer设备可能使用不同的命令
          }

          // 发送获取宏命令
          const success = await sendSetReport(command)
          if (!success) return

          // 获取响应
          const response = await sendGetReport(128)
          if (!response) {
            macroActions = []
            return
          }

          // 解析宏数据 (实际格式取决于设备协议)
          // 这里简化处理，实际需要根据协议解析动作列表
          macroActions = []
          document.getElementById('macroActions').innerHTML = ''

          // 假设前32字节是宏名称
          let macroName = ''
          for (let i = 0; i < 32; i++) {
            if (response[i] === 0) break
            macroName += String.fromCharCode(response[i])
          }

          // 假设第33字节是循环次数
          const loopCount = response[32] || 1

          // 显示宏名称和循环次数
          document.getElementById('macroName').value = macroName || `宏 ${index + 1}`
          document.getElementById('loopCount').value = loopCount

          // 解析动作数量 (假设第34字节)
          const actionCount = response[34] || 0

          // 更新宏列表计数
          const macroItem = document.querySelector(`.macro-item[data-index="${index}"]`)
          macroItem.querySelector('span:last-child').textContent = `${actionCount}个动作`

          // 实际实现中应该继续解析动作列表并显示
          if (actionCount === 0) {
            document.getElementById('macroActions').innerHTML =
              '<div class="p-4 text-center text-gray-medium text-sm">录制宏动作后将显示在这里</div>'
          } else {
            // 这里简化处理，实际需要根据协议解析每个动作
            for (let i = 0; i < actionCount; i++) {
              // 模拟动作
              addMacroActionToUI('按键按下', 'A', 100)
            }
          }
        } catch (err) {
          console.error('加载宏失败:', err)
        }
      }

      // 开始录制宏
      function startRecord() {
        if (!device) {
          showNotification('error', '操作失败', '请先连接设备')
          return
        }

        isRecording = true
        macroActions = []
        lastActionTime = Date.now()

        // 更新UI状态
        document.getElementById('startRecord').disabled = true
        document.getElementById('stopRecord').disabled = false
        document.getElementById('cancelRecord').disabled = false
        document.getElementById('recordingStatus').classList.remove('hidden')
        document.getElementById('macroActions').innerHTML = ''

        showNotification('info', '开始录制', '正在录制宏动作，请执行您的操作')
      }

      // 停止录制宏
      function stopRecord() {
        isRecording = false

        // 更新UI状态
        document.getElementById('startRecord').disabled = false
        document.getElementById('stopRecord').disabled = true
        document.getElementById('cancelRecord').disabled = true
        document.getElementById('recordingStatus').classList.add('hidden')

        // 更新宏列表计数
        const macroItem = document.querySelector(`.macro-item[data-index="${currentMacroIndex}"]`)
        macroItem.querySelector('span:last-child').textContent = `${macroActions.length}个动作`

        showNotification('success', '录制完成', `宏录制已完成，共 ${macroActions.length} 个动作`)
      }

      // 取消录制宏
      function cancelRecord() {
        isRecording = false

        // 更新UI状态
        document.getElementById('startRecord').disabled = false
        document.getElementById('stopRecord').disabled = true
        document.getElementById('cancelRecord').disabled = true
        document.getElementById('recordingStatus').classList.add('hidden')

        showNotification('info', '已取消', '宏录制已取消')
      }

      // 测试宏
      function testMacro() {
        if (macroActions.length === 0) {
          showNotification('warning', '无宏动作', '请先录制宏动作')
          return
        }

        showNotification('info', '开始测试', '正在测试宏...')
      }

      // 保存宏，带确认机制
      async function saveMacro() {
        if (!device) {
          showNotification('error', '操作失败', '请先连接设备')
          return
        }

        if (macroActions.length === 0) {
          showNotification('warning', '保存失败', '宏动作不能为空')
          return
        }

        try {
          const macroName =
            document.getElementById('macroName').value || `宏 ${currentMacroIndex + 1}`
          const loopCount = parseInt(document.getElementById('loopCount').value)

          // 构建宏数据 (实际格式取决于设备协议)
          let data = [0x06, 0x02, currentMacroIndex, loopCount, macroActions.length]

          // 根据设备协议调整命令
          if (deviceProtocol === 'razer') {
            data = [0x08, 0x02, currentMacroIndex, loopCount, macroActions.length] // Razer设备可能使用不同的命令
          }

          // 添加宏名称 (限制32字节)
          const nameBytes = new TextEncoder().encode(macroName)
          for (let i = 0; i < 32; i++) {
            data.push(i < nameBytes.length ? nameBytes[i] : 0)
          }

          // 添加宏动作
          macroActions.forEach((action) => {
            // 简单编码动作数据，实际需要根据协议
            const keyCode = action.key.charCodeAt(0) || 0
            const state = action.state === 'down' ? 0x01 : 0x00
            const delayHigh = (action.delay >> 8) & 0xff
            const delayLow = action.delay & 0xff

            data.push(keyCode, state, delayHigh, delayLow)
          })

          // 发送保存宏命令
          const success = await sendSetReport(data)
          if (!success) return

          // 验证设置是否生效
          await new Promise((resolve) => setTimeout(resolve, 100)) // 等待设备响应

          // 重新加载宏以确认
          await fetchMacroFromDevice(currentMacroIndex)
          showNotification('success', '保存成功', `宏 "${macroName}" 已保存`)
        } catch (err) {
          console.error('保存宏失败:', err)
          showNotification('error', '保存失败', '无法保存宏设置')
        }
      }

      // 监听键盘事件用于宏录制
      document.addEventListener('keydown', (e) => {
        if (!isRecording) return

        const now = Date.now()
        const delay = now - lastActionTime
        lastActionTime = now

        const action = {
          type: 'key',
          key: e.key,
          state: 'down',
          delay
        }

        macroActions.push(action)
        addMacroActionToUI('按键按下', e.key, delay)
      })

      document.addEventListener('keyup', (e) => {
        if (!isRecording) return

        const now = Date.now()
        const delay = now - lastActionTime
        lastActionTime = now

        const action = {
          type: 'key',
          key: e.key,
          state: 'up',
          delay
        }

        macroActions.push(action)
        addMacroActionToUI('按键弹起', e.key, delay)
      })

      // 添加宏动作到UI
      function addMacroActionToUI(type, key, delay) {
        const macroActionsEl = document.getElementById('macroActions')
        const actionCount = macroActionsEl.children.length + 1

        const actionEl = document.createElement('div')
        actionEl.className =
          'p-3 border-b last:border-0 flex justify-between items-center hover:bg-gray-50'
        actionEl.innerHTML = `
        <div class="flex items-center">
          <span class="w-6 h-6 rounded-full bg-gray-200 flex items-center justify-center text-xs mr-3">${actionCount}</span>
          <span>${type}：<strong>${key}</strong></span>
        </div>
        <span class="text-xs text-gray-medium">${delay}ms</span>
      `

        macroActionsEl.appendChild(actionEl)
        macroActionsEl.scrollTop = macroActionsEl.scrollHeight
      }

      // 检查固件更新
      async function checkUpdate() {
        if (!device) {
          showNotification('error', '操作失败', '请先连接设备')
          return
        }

        showNotification('info', '检查更新', '正在检查固件更新...')

        try {
          // 根据设备协议选择不同的命令
          let command = [0x07, 0x01]
          if (deviceProtocol === 'razer') {
            command = [0x09, 0x01] // Razer设备可能使用不同的命令
          }

          // 发送检查更新命令
          const success = await sendSetReport(command)
          if (!success) return

          // 获取响应
          const response = await sendGetReport(16)

          // 模拟检查更新结果
          setTimeout(() => {
            showNotification('success', '已是最新版本', '当前固件已是最新版本，无需更新')
          }, 1500)
        } catch (err) {
          console.error('检查更新失败:', err)
          showNotification('error', '检查失败', '无法检查固件更新')
        }
      }

      // 恢复出厂设置
      async function restoreDefaults() {
        if (!device) {
          showNotification('error', '操作失败', '请先连接设备')
          return
        }

        if (confirm('确定要恢复出厂设置吗？这将清除所有自定义设置并恢复默认值。')) {
          showNotification('info', '正在恢复', '正在恢复出厂设置...')

          try {
            // 根据设备协议选择不同的命令
            let command = [0x07, 0x02]
            if (deviceProtocol === 'razer') {
              command = [0x09, 0x02] // Razer设备可能使用不同的命令
            }

            // 发送恢复出厂设置命令
            const success = await sendSetReport(command)
            if (!success) return

            // 等待设备重启
            setTimeout(() => {
              // 重新获取设备信息
              getDeviceInfo()
              getCurrentReportRate()
              getCurrentCPI()
              getBacklightMode()

              showNotification('success', '恢复完成', '已成功恢复出厂设置')
            }, 2000)
          } catch (err) {
            console.error('恢复出厂设置失败:', err)
            showNotification('error', '恢复失败', '无法恢复出厂设置')
          }
        }
      }

      // 显示通知
      function showNotification(type, title, message) {
        const notification = document.getElementById('notification')
        const notificationIcon = document.getElementById('notificationIcon')
        const notificationTitle = document.getElementById('notificationTitle')
        const notificationMessage = document.getElementById('notificationMessage')

        // 设置通知类型和图标
        notification.className =
          'fixed bottom-5 right-5 p-4 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 max-w-sm'

        if (type === 'success') {
          notification.classList.add('bg-success/10', 'border', 'border-success/30')
          notificationIcon.className = 'fa fa-check-circle text-success mr-3 text-xl'
        } else if (type === 'error') {
          notification.classList.add('bg-danger/10', 'border', 'border-danger/30')
          notificationIcon.className = 'fa fa-exclamation-circle text-danger mr-3 text-xl'
        } else if (type === 'warning') {
          notification.classList.add('bg-warning/10', 'border', 'border-warning/30')
          notificationIcon.className = 'fa fa-exclamation-triangle text-warning mr-3 text-xl'
        } else {
          notification.classList.add('bg-primary/10', 'border', 'border-primary/30')
          notificationIcon.className = 'fa fa-info-circle text-primary mr-3 text-xl'
        }

        // 设置通知内容
        notificationTitle.textContent = title
        notificationMessage.textContent = message

        // 显示通知
        notification.classList.remove('translate-y-20', 'opacity-0', 'hidden')

        // 3秒后自动隐藏
        setTimeout(hideNotification, 3000)
      }

      // 隐藏通知
      function hideNotification() {
        const notification = document.getElementById('notification')
        notification.classList.add('translate-y-20', 'opacity-0')

        setTimeout(() => {
          notification.classList.add('hidden')
        }, 300)
      }
    </script>
  </body>
</html>
